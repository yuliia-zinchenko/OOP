<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Read&amp;Watch: django.db.models.fields.related_descriptors Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Read&amp;Watch<span id="projectnumber">&#160;1.0</span>
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('namespacedjango_1_1db_1_1models_1_1fields_1_1related__descriptors.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">django.db.models.fields.related_descriptors Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_foreign_key_deferred_attribute.html">ForeignKeyDeferredAttribute</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_forward_many_to_one_descriptor.html">ForwardManyToOneDescriptor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_forward_one_to_one_descriptor.html">ForwardOneToOneDescriptor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_many_to_many_descriptor.html">ManyToManyDescriptor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_reverse_many_to_one_descriptor.html">ReverseManyToOneDescriptor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classdjango_1_1db_1_1models_1_1fields_1_1related__descriptors_1_1_reverse_one_to_one_descriptor.html">ReverseOneToOneDescriptor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:afa03ef3a585e27184b9bbf788094cf65" id="r_afa03ef3a585e27184b9bbf788094cf65"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#afa03ef3a585e27184b9bbf788094cf65">_filter_prefetch_queryset</a> (queryset, field_name, instances)</td></tr>
<tr class="separator:afa03ef3a585e27184b9bbf788094cf65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6c10dab2e0e460b34fd6d3207e609c7c" id="r_a6c10dab2e0e460b34fd6d3207e609c7c"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6c10dab2e0e460b34fd6d3207e609c7c">create_reverse_many_to_one_manager</a> (superclass, rel)</td></tr>
<tr class="separator:a6c10dab2e0e460b34fd6d3207e609c7c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2ad546d132772efdf403a4b12fc380d8" id="r_a2ad546d132772efdf403a4b12fc380d8"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2ad546d132772efdf403a4b12fc380d8">create_forward_many_to_many_manager</a> (superclass, rel, <a class="el" href="#afe5e5775a26d78c3a643e18d11a544ab">reverse</a>)</td></tr>
<tr class="separator:a2ad546d132772efdf403a4b12fc380d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a2d4f6982d2433fa20c5b1a44f4cd95c9" id="r_a2d4f6982d2433fa20c5b1a44f4cd95c9"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">instance</a> = instance</td></tr>
<tr class="separator:a2d4f6982d2433fa20c5b1a44f4cd95c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af42babb78272caa993abe3f2e8c5b7af" id="r_af42babb78272caa993abe3f2e8c5b7af"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af42babb78272caa993abe3f2e8c5b7af">model</a> = rel.related_model</td></tr>
<tr class="separator:af42babb78272caa993abe3f2e8c5b7af"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5bcaffa31dadce5a2e6ef1a504bd09c3" id="r_a5bcaffa31dadce5a2e6ef1a504bd09c3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5bcaffa31dadce5a2e6ef1a504bd09c3">field</a> = rel.field</td></tr>
<tr class="separator:a5bcaffa31dadce5a2e6ef1a504bd09c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a673ae17f91c49dce56a7b9e1f0f41470" id="r_a673ae17f91c49dce56a7b9e1f0f41470"><td class="memItemLeft" align="right" valign="top">dict&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a673ae17f91c49dce56a7b9e1f0f41470">core_filters</a> = {self.field.name: <a class="el" href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">instance</a>}</td></tr>
<tr class="separator:a673ae17f91c49dce56a7b9e1f0f41470"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a467ceebd29540846b8fe8c3a673f3394" id="r_a467ceebd29540846b8fe8c3a673f3394"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a467ceebd29540846b8fe8c3a673f3394">_db</a> = self.instance)</td></tr>
<tr class="separator:a467ceebd29540846b8fe8c3a673f3394"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2c6e5dc63d0890d13975747dbeac400" id="r_ae2c6e5dc63d0890d13975747dbeac400"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae2c6e5dc63d0890d13975747dbeac400">add</a> = True):</td></tr>
<tr class="separator:ae2c6e5dc63d0890d13975747dbeac400"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26699fb0e36f5d12dd0a7f4860b083e3" id="r_a26699fb0e36f5d12dd0a7f4860b083e3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a26699fb0e36f5d12dd0a7f4860b083e3">create</a> = True</td></tr>
<tr class="separator:a26699fb0e36f5d12dd0a7f4860b083e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aee77a3024dd052b98723409b59e7d8eb" id="r_aee77a3024dd052b98723409b59e7d8eb"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aee77a3024dd052b98723409b59e7d8eb">get_or_create</a> = True</td></tr>
<tr class="separator:aee77a3024dd052b98723409b59e7d8eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab96d91c80eef1aca61b7697c37ee61db" id="r_ab96d91c80eef1aca61b7697c37ee61db"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab96d91c80eef1aca61b7697c37ee61db">update_or_create</a> = True</td></tr>
<tr class="separator:ab96d91c80eef1aca61b7697c37ee61db"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af9fc51a0d300117b8545f65d72602189" id="r_af9fc51a0d300117b8545f65d72602189"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af9fc51a0d300117b8545f65d72602189">remove</a> = True):</td></tr>
<tr class="separator:af9fc51a0d300117b8545f65d72602189"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab30b373b473f7e0af7c445611fce9411" id="r_ab30b373b473f7e0af7c445611fce9411"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab30b373b473f7e0af7c445611fce9411">clear</a> = True):</td></tr>
<tr class="separator:ab30b373b473f7e0af7c445611fce9411"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a76709af4ab7f9f51879819876156f958" id="r_a76709af4ab7f9f51879819876156f958"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a76709af4ab7f9f51879819876156f958">set</a> = False):</td></tr>
<tr class="separator:a76709af4ab7f9f51879819876156f958"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac734e56d5215d9fd6734fd090837e407" id="r_ac734e56d5215d9fd6734fd090837e407"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac734e56d5215d9fd6734fd090837e407">query_field_name</a> = rel.field.related_query_name()</td></tr>
<tr class="separator:ac734e56d5215d9fd6734fd090837e407"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aefcc4f73d38a9ff1abbbf8b685d428d6" id="r_aefcc4f73d38a9ff1abbbf8b685d428d6"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aefcc4f73d38a9ff1abbbf8b685d428d6">prefetch_cache_name</a> = rel.field.name</td></tr>
<tr class="separator:aefcc4f73d38a9ff1abbbf8b685d428d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad7db328efb2d4bc74d5f8fac3864e9ba" id="r_ad7db328efb2d4bc74d5f8fac3864e9ba"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad7db328efb2d4bc74d5f8fac3864e9ba">source_field_name</a> = rel.field.m2m_field_name()</td></tr>
<tr class="separator:ad7db328efb2d4bc74d5f8fac3864e9ba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67bd88f37d0cdc6e4bbbba682984518d" id="r_a67bd88f37d0cdc6e4bbbba682984518d"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a67bd88f37d0cdc6e4bbbba682984518d">target_field_name</a> = rel.field.m2m_reverse_field_name()</td></tr>
<tr class="separator:a67bd88f37d0cdc6e4bbbba682984518d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa77338e7519a3fefad05d3a1ce5fe1fc" id="r_aa77338e7519a3fefad05d3a1ce5fe1fc"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa77338e7519a3fefad05d3a1ce5fe1fc">symmetrical</a> = rel.symmetrical</td></tr>
<tr class="separator:aa77338e7519a3fefad05d3a1ce5fe1fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6dd62a8f1fc42a6bebd6732535aa92b7" id="r_a6dd62a8f1fc42a6bebd6732535aa92b7"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6dd62a8f1fc42a6bebd6732535aa92b7">through</a> = rel.through</td></tr>
<tr class="separator:a6dd62a8f1fc42a6bebd6732535aa92b7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe5e5775a26d78c3a643e18d11a544ab" id="r_afe5e5775a26d78c3a643e18d11a544ab"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#afe5e5775a26d78c3a643e18d11a544ab">reverse</a> = reverse</td></tr>
<tr class="separator:afe5e5775a26d78c3a643e18d11a544ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa79e9a3830b25d12956c03af331b0ac7" id="r_aa79e9a3830b25d12956c03af331b0ac7"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa79e9a3830b25d12956c03af331b0ac7">source_field</a> = self.through._meta.get_field(self.source_field_name)</td></tr>
<tr class="separator:aa79e9a3830b25d12956c03af331b0ac7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a467795b8a5e9c1011924cd2735457bbc" id="r_a467795b8a5e9c1011924cd2735457bbc"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a467795b8a5e9c1011924cd2735457bbc">target_field</a> = self.through._meta.get_field(self.target_field_name)</td></tr>
<tr class="separator:a467795b8a5e9c1011924cd2735457bbc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec979db6b6d598a5cb6c1ac6931b097a" id="r_aec979db6b6d598a5cb6c1ac6931b097a"><td class="memItemLeft" align="right" valign="top">dict&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aec979db6b6d598a5cb6c1ac6931b097a">pk_field_names</a> = {}</td></tr>
<tr class="separator:aec979db6b6d598a5cb6c1ac6931b097a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a302babfeed8a95db9673dc64eefe79a6" id="r_a302babfeed8a95db9673dc64eefe79a6"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a302babfeed8a95db9673dc64eefe79a6">related_val</a> = self.source_field.get_foreign_related_value(<a class="el" href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">instance</a>)</td></tr>
<tr class="separator:a302babfeed8a95db9673dc64eefe79a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><pre class="fragment">Accessors for related objects.

When a field defines a relation between two models, each model class provides
an attribute to access related instances of the other model class (unless the
reverse accessor has been disabled with related_name='+').

Accessors are implemented as descriptors in order to customize access and
assignment. This module defines the descriptor classes.

Forward accessors follow foreign keys. Reverse accessors trace them back. For
example, with the following models::

    class Parent(Model):
        pass

    class Child(Model):
        parent = ForeignKey(Parent, related_name='children')

 ``child.parent`` is a forward many-to-one relation. ``parent.children`` is a
reverse many-to-one relation.

There are three types of relations (many-to-one, one-to-one, and many-to-many)
and two directions (forward and reverse) for a total of six combinations.

1. Related instance on the forward side of a many-to-one relation:
   ``ForwardManyToOneDescriptor``.

   Uniqueness of foreign key values is irrelevant to accessing the related
   instance, making the many-to-one and one-to-one cases identical as far as
   the descriptor is concerned. The constraint is checked upstream (unicity
   validation in forms) or downstream (unique indexes in the database).

2. Related instance on the forward side of a one-to-one
   relation: ``ForwardOneToOneDescriptor``.

   It avoids querying the database when accessing the parent link field in
   a multi-table inheritance scenario.

3. Related instance on the reverse side of a one-to-one relation:
   ``ReverseOneToOneDescriptor``.

   One-to-one relations are asymmetrical, despite the apparent symmetry of the
   name, because they're implemented in the database with a foreign key from
   one table to another. As a consequence ``ReverseOneToOneDescriptor`` is
   slightly different from ``ForwardManyToOneDescriptor``.

4. Related objects manager for related instances on the reverse side of a
   many-to-one relation: ``ReverseManyToOneDescriptor``.

   Unlike the previous two classes, this one provides access to a collection
   of objects. It returns a manager rather than an instance.

5. Related objects manager for related instances on the forward or reverse
   sides of a many-to-many relation: ``ManyToManyDescriptor``.

   Many-to-many relations are symmetrical. The syntax of Django models
   requires declaring them on one side but that's an implementation detail.
   They could be declared on the other side without any change in behavior.
   Therefore the forward and reverse descriptors can be the same.

   If you're looking for ``ForwardManyToManyDescriptor`` or
   ``ReverseManyToManyDescriptor``, use ``ManyToManyDescriptor`` instead.
</pre> </div><h2 class="groupheader">Function Documentation</h2>
<a id="afa03ef3a585e27184b9bbf788094cf65" name="afa03ef3a585e27184b9bbf788094cf65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa03ef3a585e27184b9bbf788094cf65">&#9670;&#160;</a></span>_filter_prefetch_queryset()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors._filter_prefetch_queryset </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>queryset</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>field_name</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>instances</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel protected">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00097">97</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   97</span><span class="keyword">def </span>_filter_prefetch_queryset(queryset, field_name, instances):</div>
<div class="line"><span class="lineno">   98</span>    predicate = Q(**{f<span class="stringliteral">&quot;{field_name}__in&quot;</span>: instances})</div>
<div class="line"><span class="lineno">   99</span>    db = queryset._db <span class="keywordflow">or</span> DEFAULT_DB_ALIAS</div>
<div class="line"><span class="lineno">  100</span>    <span class="keywordflow">if</span> queryset.query.is_sliced:</div>
<div class="line"><span class="lineno">  101</span>        <span class="keywordflow">if</span> <span class="keywordflow">not</span> connections[db].features.supports_over_clause:</div>
<div class="line"><span class="lineno">  102</span>            <span class="keywordflow">raise</span> NotSupportedError(</div>
<div class="line"><span class="lineno">  103</span>                <span class="stringliteral">&quot;Prefetching from a limited queryset is only supported on backends &quot;</span></div>
<div class="line"><span class="lineno">  104</span>                <span class="stringliteral">&quot;that support window functions.&quot;</span></div>
<div class="line"><span class="lineno">  105</span>            )</div>
<div class="line"><span class="lineno">  106</span>        low_mark, high_mark = queryset.query.low_mark, queryset.query.high_mark</div>
<div class="line"><span class="lineno">  107</span>        order_by = [</div>
<div class="line"><span class="lineno">  108</span>            expr <span class="keywordflow">for</span> expr, _ <span class="keywordflow">in</span> queryset.query.get_compiler(using=db).get_order_by()</div>
<div class="line"><span class="lineno">  109</span>        ]</div>
<div class="line"><span class="lineno">  110</span>        window = Window(RowNumber(), partition_by=field_name, order_by=order_by)</div>
<div class="line"><span class="lineno">  111</span>        predicate &amp;= GreaterThan(window, low_mark)</div>
<div class="line"><span class="lineno">  112</span>        <span class="keywordflow">if</span> high_mark <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  113</span>            predicate &amp;= LessThanOrEqual(window, high_mark)</div>
<div class="line"><span class="lineno">  114</span>        queryset.query.clear_limits()</div>
<div class="line"><span class="lineno">  115</span>    <span class="keywordflow">return</span> queryset.filter(predicate)</div>
<div class="line"><span class="lineno">  116</span> </div>
<div class="line"><span class="lineno">  117</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a2ad546d132772efdf403a4b12fc380d8" name="a2ad546d132772efdf403a4b12fc380d8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2ad546d132772efdf403a4b12fc380d8">&#9670;&#160;</a></span>create_forward_many_to_many_manager()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.create_forward_many_to_many_manager </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>superclass</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>rel</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>reverse</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Create a manager for the either side of a many-to-many relation.

This manager subclasses another manager, generally the default manager of
the related model, and adds behaviors specific to many-to-many relations.
</pre> 
<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01032">1032</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1032</span><span class="keyword">def </span>create_forward_many_to_many_manager(superclass, rel, reverse):</div>
<div class="line"><span class="lineno"> 1033</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1034</span><span class="stringliteral">    Create a manager for the either side of a many-to-many relation.</span></div>
<div class="line"><span class="lineno"> 1035</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno"> 1036</span><span class="stringliteral">    This manager subclasses another manager, generally the default manager of</span></div>
<div class="line"><span class="lineno"> 1037</span><span class="stringliteral">    the related model, and adds behaviors specific to many-to-many relations.</span></div>
<div class="line"><span class="lineno"> 1038</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1039</span> </div>
<div class="line"><span class="lineno"> 1040</span>    <span class="keyword">class </span>ManyRelatedManager(superclass, AltersData):</div>
<div class="line"><span class="lineno"> 1041</span>        <span class="keyword">def </span>__init__(self, instance=None):</div>
<div class="line"><span class="lineno"> 1042</span>            super().__init__()</div>
<div class="line"><span class="lineno"> 1043</span> </div>
<div class="line"><span class="lineno"> 1044</span>            self.instance = instance</div>
<div class="line"><span class="lineno"> 1045</span> </div>
<div class="line"><span class="lineno"> 1046</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> reverse:</div>
<div class="line"><span class="lineno"> 1047</span>                self.model = rel.model</div>
<div class="line"><span class="lineno"> 1048</span>                self.query_field_name = rel.field.related_query_name()</div>
<div class="line"><span class="lineno"> 1049</span>                self.prefetch_cache_name = rel.field.name</div>
<div class="line"><span class="lineno"> 1050</span>                self.source_field_name = rel.field.m2m_field_name()</div>
<div class="line"><span class="lineno"> 1051</span>                self.target_field_name = rel.field.m2m_reverse_field_name()</div>
<div class="line"><span class="lineno"> 1052</span>                self.symmetrical = rel.symmetrical</div>
<div class="line"><span class="lineno"> 1053</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1054</span>                self.model = rel.related_model</div>
<div class="line"><span class="lineno"> 1055</span>                self.query_field_name = rel.field.name</div>
<div class="line"><span class="lineno"> 1056</span>                self.prefetch_cache_name = rel.field.related_query_name()</div>
<div class="line"><span class="lineno"> 1057</span>                self.source_field_name = rel.field.m2m_reverse_field_name()</div>
<div class="line"><span class="lineno"> 1058</span>                self.target_field_name = rel.field.m2m_field_name()</div>
<div class="line"><span class="lineno"> 1059</span>                self.symmetrical = <span class="keyword">False</span></div>
<div class="line"><span class="lineno"> 1060</span> </div>
<div class="line"><span class="lineno"> 1061</span>            self.through = rel.through</div>
<div class="line"><span class="lineno"> 1062</span>            self.reverse = reverse</div>
<div class="line"><span class="lineno"> 1063</span> </div>
<div class="line"><span class="lineno"> 1064</span>            self.source_field = self.through._meta.get_field(self.source_field_name)</div>
<div class="line"><span class="lineno"> 1065</span>            self.target_field = self.through._meta.get_field(self.target_field_name)</div>
<div class="line"><span class="lineno"> 1066</span> </div>
<div class="line"><span class="lineno"> 1067</span>            self.core_filters = {}</div>
<div class="line"><span class="lineno"> 1068</span>            self.pk_field_names = {}</div>
<div class="line"><span class="lineno"> 1069</span>            <span class="keywordflow">for</span> lh_field, rh_field <span class="keywordflow">in</span> self.source_field.related_fields:</div>
<div class="line"><span class="lineno"> 1070</span>                core_filter_key = <span class="stringliteral">&quot;%s__%s&quot;</span> % (self.query_field_name, rh_field.name)</div>
<div class="line"><span class="lineno"> 1071</span>                self.core_filters[core_filter_key] = getattr(instance, rh_field.attname)</div>
<div class="line"><span class="lineno"> 1072</span>                self.pk_field_names[lh_field.name] = rh_field.name</div>
<div class="line"><span class="lineno"> 1073</span> </div>
<div class="line"><span class="lineno"> 1074</span>            self.related_val = self.source_field.get_foreign_related_value(instance)</div>
<div class="line"><span class="lineno"> 1075</span>            <span class="keywordflow">if</span> <span class="keywordtype">None</span> <span class="keywordflow">in</span> self.related_val:</div>
<div class="line"><span class="lineno"> 1076</span>                <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno"> 1077</span>                    <span class="stringliteral">&#39;&quot;%r&quot; needs to have a value for field &quot;%s&quot; before &#39;</span></div>
<div class="line"><span class="lineno"> 1078</span>                    <span class="stringliteral">&quot;this many-to-many relationship can be used.&quot;</span></div>
<div class="line"><span class="lineno"> 1079</span>                    % (instance, self.pk_field_names[self.source_field_name])</div>
<div class="line"><span class="lineno"> 1080</span>                )</div>
<div class="line"><span class="lineno"> 1081</span>            <span class="comment"># Even if this relation is not to pk, we require still pk value.</span></div>
<div class="line"><span class="lineno"> 1082</span>            <span class="comment"># The wish is that the instance has been already saved to DB,</span></div>
<div class="line"><span class="lineno"> 1083</span>            <span class="comment"># although having a pk value isn&#39;t a guarantee of that.</span></div>
<div class="line"><span class="lineno"> 1084</span>            <span class="keywordflow">if</span> instance.pk <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno"> 1085</span>                <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno"> 1086</span>                    <span class="stringliteral">&quot;%r instance needs to have a primary key value before &quot;</span></div>
<div class="line"><span class="lineno"> 1087</span>                    <span class="stringliteral">&quot;a many-to-many relationship can be used.&quot;</span></div>
<div class="line"><span class="lineno"> 1088</span>                    % instance.__class__.__name__</div>
<div class="line"><span class="lineno"> 1089</span>                )</div>
<div class="line"><span class="lineno"> 1090</span> </div>
<div class="line"><span class="lineno"> 1091</span>        <span class="keyword">def </span>__call__(self, *, manager):</div>
<div class="line"><span class="lineno"> 1092</span>            manager = getattr(self.model, manager)</div>
<div class="line"><span class="lineno"> 1093</span>            manager_class = create_forward_many_to_many_manager(</div>
<div class="line"><span class="lineno"> 1094</span>                manager.__class__, rel, reverse</div>
<div class="line"><span class="lineno"> 1095</span>            )</div>
<div class="line"><span class="lineno"> 1096</span>            <span class="keywordflow">return</span> manager_class(instance=self.instance)</div>
<div class="line"><span class="lineno"> 1097</span> </div>
<div class="line"><span class="lineno"> 1098</span>        do_not_call_in_templates = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1099</span> </div>
<div class="line"><span class="lineno"> 1100</span>        <span class="keyword">def </span>_build_remove_filters(self, removed_vals):</div>
<div class="line"><span class="lineno"> 1101</span>            filters = Q.create([(self.source_field_name, self.related_val)])</div>
<div class="line"><span class="lineno"> 1102</span>            <span class="comment"># No need to add a subquery condition if removed_vals is a QuerySet without</span></div>
<div class="line"><span class="lineno"> 1103</span>            <span class="comment"># filters.</span></div>
<div class="line"><span class="lineno"> 1104</span>            removed_vals_filters = (</div>
<div class="line"><span class="lineno"> 1105</span>                <span class="keywordflow">not</span> isinstance(removed_vals, QuerySet) <span class="keywordflow">or</span> removed_vals._has_filters()</div>
<div class="line"><span class="lineno"> 1106</span>            )</div>
<div class="line"><span class="lineno"> 1107</span>            <span class="keywordflow">if</span> removed_vals_filters:</div>
<div class="line"><span class="lineno"> 1108</span>                filters &amp;= Q.create([(f<span class="stringliteral">&quot;{self.target_field_name}__in&quot;</span>, removed_vals)])</div>
<div class="line"><span class="lineno"> 1109</span>            <span class="keywordflow">if</span> self.symmetrical:</div>
<div class="line"><span class="lineno"> 1110</span>                symmetrical_filters = Q.create(</div>
<div class="line"><span class="lineno"> 1111</span>                    [(self.target_field_name, self.related_val)]</div>
<div class="line"><span class="lineno"> 1112</span>                )</div>
<div class="line"><span class="lineno"> 1113</span>                <span class="keywordflow">if</span> removed_vals_filters:</div>
<div class="line"><span class="lineno"> 1114</span>                    symmetrical_filters &amp;= Q.create(</div>
<div class="line"><span class="lineno"> 1115</span>                        [(f<span class="stringliteral">&quot;{self.source_field_name}__in&quot;</span>, removed_vals)]</div>
<div class="line"><span class="lineno"> 1116</span>                    )</div>
<div class="line"><span class="lineno"> 1117</span>                filters |= symmetrical_filters</div>
<div class="line"><span class="lineno"> 1118</span>            <span class="keywordflow">return</span> filters</div>
<div class="line"><span class="lineno"> 1119</span> </div>
<div class="line"><span class="lineno"> 1120</span>        <span class="keyword">def </span>_apply_rel_filters(self, queryset):</div>
<div class="line"><span class="lineno"> 1121</span>            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1122</span><span class="stringliteral">            Filter the queryset for the instance this manager is bound to.</span></div>
<div class="line"><span class="lineno"> 1123</span><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1124</span>            queryset._add_hints(instance=self.instance)</div>
<div class="line"><span class="lineno"> 1125</span>            <span class="keywordflow">if</span> self._db:</div>
<div class="line"><span class="lineno"> 1126</span>                queryset = queryset.using(self._db)</div>
<div class="line"><span class="lineno"> 1127</span>            queryset._defer_next_filter = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1128</span>            <span class="keywordflow">return</span> queryset._next_is_sticky().filter(**self.core_filters)</div>
<div class="line"><span class="lineno"> 1129</span> </div>
<div class="line"><span class="lineno"> 1130</span>        <span class="keyword">def </span>get_prefetch_cache(self):</div>
<div class="line"><span class="lineno"> 1131</span>            <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno"> 1132</span>                <span class="keywordflow">return</span> self.instance._prefetched_objects_cache[self.prefetch_cache_name]</div>
<div class="line"><span class="lineno"> 1133</span>            <span class="keywordflow">except</span> (AttributeError, KeyError):</div>
<div class="line"><span class="lineno"> 1134</span>                <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1135</span> </div>
<div class="line"><span class="lineno"> 1136</span>        <span class="keyword">def </span>_remove_prefetched_objects(self):</div>
<div class="line"><span class="lineno"> 1137</span>            <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno"> 1138</span>                self.instance._prefetched_objects_cache.pop(self.prefetch_cache_name)</div>
<div class="line"><span class="lineno"> 1139</span>            <span class="keywordflow">except</span> (AttributeError, KeyError):</div>
<div class="line"><span class="lineno"> 1140</span>                <span class="keywordflow">pass</span>  <span class="comment"># nothing to clear from cache</span></div>
<div class="line"><span class="lineno"> 1141</span> </div>
<div class="line"><span class="lineno"> 1142</span>        <span class="keyword">def </span>get_queryset(self):</div>
<div class="line"><span class="lineno"> 1143</span>            <span class="keywordflow">if</span> (cache := self.get_prefetch_cache()) <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno"> 1144</span>                <span class="keywordflow">return</span> cache</div>
<div class="line"><span class="lineno"> 1145</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1146</span>                queryset = super().get_queryset()</div>
<div class="line"><span class="lineno"> 1147</span>                <span class="keywordflow">return</span> self._apply_rel_filters(queryset)</div>
<div class="line"><span class="lineno"> 1148</span> </div>
<div class="line"><span class="lineno"> 1149</span>        <span class="keyword">def </span>get_prefetch_queryset(self, instances, queryset=None):</div>
<div class="line"><span class="lineno"> 1150</span>            warnings.warn(</div>
<div class="line"><span class="lineno"> 1151</span>                <span class="stringliteral">&quot;get_prefetch_queryset() is deprecated. Use get_prefetch_querysets() &quot;</span></div>
<div class="line"><span class="lineno"> 1152</span>                <span class="stringliteral">&quot;instead.&quot;</span>,</div>
<div class="line"><span class="lineno"> 1153</span>                RemovedInDjango60Warning,</div>
<div class="line"><span class="lineno"> 1154</span>                stacklevel=2,</div>
<div class="line"><span class="lineno"> 1155</span>            )</div>
<div class="line"><span class="lineno"> 1156</span>            <span class="keywordflow">if</span> queryset <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno"> 1157</span>                <span class="keywordflow">return</span> self.get_prefetch_querysets(instances)</div>
<div class="line"><span class="lineno"> 1158</span>            <span class="keywordflow">return</span> self.get_prefetch_querysets(instances, [queryset])</div>
<div class="line"><span class="lineno"> 1159</span> </div>
<div class="line"><span class="lineno"> 1160</span>        <span class="keyword">def </span>get_prefetch_querysets(self, instances, querysets=None):</div>
<div class="line"><span class="lineno"> 1161</span>            <span class="keywordflow">if</span> querysets <span class="keywordflow">and</span> len(querysets) != 1:</div>
<div class="line"><span class="lineno"> 1162</span>                <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno"> 1163</span>                    <span class="stringliteral">&quot;querysets argument of get_prefetch_querysets() should have a &quot;</span></div>
<div class="line"><span class="lineno"> 1164</span>                    <span class="stringliteral">&quot;length of 1.&quot;</span></div>
<div class="line"><span class="lineno"> 1165</span>                )</div>
<div class="line"><span class="lineno"> 1166</span>            queryset = querysets[0] <span class="keywordflow">if</span> querysets <span class="keywordflow">else</span> super().get_queryset()</div>
<div class="line"><span class="lineno"> 1167</span>            queryset._add_hints(instance=instances[0])</div>
<div class="line"><span class="lineno"> 1168</span>            queryset = queryset.using(queryset._db <span class="keywordflow">or</span> self._db)</div>
<div class="line"><span class="lineno"> 1169</span>            queryset = _filter_prefetch_queryset(</div>
<div class="line"><span class="lineno"> 1170</span>                queryset._next_is_sticky(), self.query_field_name, instances</div>
<div class="line"><span class="lineno"> 1171</span>            )</div>
<div class="line"><span class="lineno"> 1172</span> </div>
<div class="line"><span class="lineno"> 1173</span>            <span class="comment"># M2M: need to annotate the query in order to get the primary model</span></div>
<div class="line"><span class="lineno"> 1174</span>            <span class="comment"># that the secondary model was actually related to. We know that</span></div>
<div class="line"><span class="lineno"> 1175</span>            <span class="comment"># there will already be a join on the join table, so we can just add</span></div>
<div class="line"><span class="lineno"> 1176</span>            <span class="comment"># the select.</span></div>
<div class="line"><span class="lineno"> 1177</span> </div>
<div class="line"><span class="lineno"> 1178</span>            <span class="comment"># For non-autocreated &#39;through&#39; models, can&#39;t assume we are</span></div>
<div class="line"><span class="lineno"> 1179</span>            <span class="comment"># dealing with PK values.</span></div>
<div class="line"><span class="lineno"> 1180</span>            fk = self.through._meta.get_field(self.source_field_name)</div>
<div class="line"><span class="lineno"> 1181</span>            join_table = fk.model._meta.db_table</div>
<div class="line"><span class="lineno"> 1182</span>            connection = connections[queryset.db]</div>
<div class="line"><span class="lineno"> 1183</span>            qn = connection.ops.quote_name</div>
<div class="line"><span class="lineno"> 1184</span>            queryset = queryset.extra(</div>
<div class="line"><span class="lineno"> 1185</span>                select={</div>
<div class="line"><span class="lineno"> 1186</span>                    <span class="stringliteral">&quot;_prefetch_related_val_%s&quot;</span></div>
<div class="line"><span class="lineno"> 1187</span>                    % f.attname: <span class="stringliteral">&quot;%s.%s&quot;</span></div>
<div class="line"><span class="lineno"> 1188</span>                    % (qn(join_table), qn(f.column))</div>
<div class="line"><span class="lineno"> 1189</span>                    <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fk.local_related_fields</div>
<div class="line"><span class="lineno"> 1190</span>                }</div>
<div class="line"><span class="lineno"> 1191</span>            )</div>
<div class="line"><span class="lineno"> 1192</span>            <span class="keywordflow">return</span> (</div>
<div class="line"><span class="lineno"> 1193</span>                queryset,</div>
<div class="line"><span class="lineno"> 1194</span>                <span class="keyword">lambda</span> result: tuple(</div>
<div class="line"><span class="lineno"> 1195</span>                    f.get_db_prep_value(</div>
<div class="line"><span class="lineno"> 1196</span>                        getattr(result, f<span class="stringliteral">&quot;_prefetch_related_val_{f.attname}&quot;</span>),</div>
<div class="line"><span class="lineno"> 1197</span>                        connection,</div>
<div class="line"><span class="lineno"> 1198</span>                    )</div>
<div class="line"><span class="lineno"> 1199</span>                    <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fk.local_related_fields</div>
<div class="line"><span class="lineno"> 1200</span>                ),</div>
<div class="line"><span class="lineno"> 1201</span>                <span class="keyword">lambda</span> inst: tuple(</div>
<div class="line"><span class="lineno"> 1202</span>                    f.get_db_prep_value(getattr(inst, f.attname), connection)</div>
<div class="line"><span class="lineno"> 1203</span>                    <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fk.foreign_related_fields</div>
<div class="line"><span class="lineno"> 1204</span>                ),</div>
<div class="line"><span class="lineno"> 1205</span>                <span class="keyword">False</span>,</div>
<div class="line"><span class="lineno"> 1206</span>                self.prefetch_cache_name,</div>
<div class="line"><span class="lineno"> 1207</span>                <span class="keyword">False</span>,</div>
<div class="line"><span class="lineno"> 1208</span>            )</div>
<div class="line"><span class="lineno"> 1209</span> </div>
<div class="line"><span class="lineno"> 1210</span>        <span class="preprocessor">@property</span></div>
<div class="line"><span class="lineno"> 1211</span>        <span class="keyword">def </span>constrained_target(self):</div>
<div class="line"><span class="lineno"> 1212</span>            <span class="comment"># If the through relation&#39;s target field&#39;s foreign integrity is</span></div>
<div class="line"><span class="lineno"> 1213</span>            <span class="comment"># enforced, the query can be performed solely against the through</span></div>
<div class="line"><span class="lineno"> 1214</span>            <span class="comment"># table as the INNER JOIN&#39;ing against target table is unnecessary.</span></div>
<div class="line"><span class="lineno"> 1215</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.target_field.db_constraint:</div>
<div class="line"><span class="lineno"> 1216</span>                <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1217</span>            db = router.db_for_read(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1218</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> connections[db].features.supports_foreign_keys:</div>
<div class="line"><span class="lineno"> 1219</span>                <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1220</span>            hints = {<span class="stringliteral">&quot;instance&quot;</span>: self.instance}</div>
<div class="line"><span class="lineno"> 1221</span>            manager = self.through._base_manager.db_manager(db, hints=hints)</div>
<div class="line"><span class="lineno"> 1222</span>            filters = {self.source_field_name: self.instance.pk}</div>
<div class="line"><span class="lineno"> 1223</span>            <span class="comment"># Nullable target rows must be excluded as well as they would have</span></div>
<div class="line"><span class="lineno"> 1224</span>            <span class="comment"># been filtered out from an INNER JOIN.</span></div>
<div class="line"><span class="lineno"> 1225</span>            <span class="keywordflow">if</span> self.target_field.null:</div>
<div class="line"><span class="lineno"> 1226</span>                filters[<span class="stringliteral">&quot;%s__isnull&quot;</span> % self.target_field_name] = <span class="keyword">False</span></div>
<div class="line"><span class="lineno"> 1227</span>            <span class="keywordflow">return</span> manager.filter(**filters)</div>
<div class="line"><span class="lineno"> 1228</span> </div>
<div class="line"><span class="lineno"> 1229</span>        <span class="keyword">def </span>exists(self):</div>
<div class="line"><span class="lineno"> 1230</span>            <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno"> 1231</span>                superclass <span class="keywordflow">is</span> Manager</div>
<div class="line"><span class="lineno"> 1232</span>                <span class="keywordflow">and</span> self.get_prefetch_cache() <span class="keywordflow">is</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1233</span>                <span class="keywordflow">and</span> (constrained_target := self.constrained_target) <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1234</span>            ):</div>
<div class="line"><span class="lineno"> 1235</span>                <span class="keywordflow">return</span> constrained_target.exists()</div>
<div class="line"><span class="lineno"> 1236</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1237</span>                <span class="keywordflow">return</span> super().exists()</div>
<div class="line"><span class="lineno"> 1238</span> </div>
<div class="line"><span class="lineno"> 1239</span>        <span class="keyword">def </span>count(self):</div>
<div class="line"><span class="lineno"> 1240</span>            <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno"> 1241</span>                superclass <span class="keywordflow">is</span> Manager</div>
<div class="line"><span class="lineno"> 1242</span>                <span class="keywordflow">and</span> self.get_prefetch_cache() <span class="keywordflow">is</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1243</span>                <span class="keywordflow">and</span> (constrained_target := self.constrained_target) <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno"> 1244</span>            ):</div>
<div class="line"><span class="lineno"> 1245</span>                <span class="keywordflow">return</span> constrained_target.count()</div>
<div class="line"><span class="lineno"> 1246</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1247</span>                <span class="keywordflow">return</span> super().count()</div>
<div class="line"><span class="lineno"> 1248</span> </div>
<div class="line"><span class="lineno"> 1249</span>        <span class="keyword">def </span>add(self, *objs, through_defaults=None):</div>
<div class="line"><span class="lineno"> 1250</span>            self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno"> 1251</span>            db = router.db_for_write(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1252</span>            <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno"> 1253</span>                self._add_items(</div>
<div class="line"><span class="lineno"> 1254</span>                    self.source_field_name,</div>
<div class="line"><span class="lineno"> 1255</span>                    self.target_field_name,</div>
<div class="line"><span class="lineno"> 1256</span>                    *objs,</div>
<div class="line"><span class="lineno"> 1257</span>                    through_defaults=through_defaults,</div>
<div class="line"><span class="lineno"> 1258</span>                )</div>
<div class="line"><span class="lineno"> 1259</span>                <span class="comment"># If this is a symmetrical m2m relation to self, add the mirror</span></div>
<div class="line"><span class="lineno"> 1260</span>                <span class="comment"># entry in the m2m table.</span></div>
<div class="line"><span class="lineno"> 1261</span>                <span class="keywordflow">if</span> self.symmetrical:</div>
<div class="line"><span class="lineno"> 1262</span>                    self._add_items(</div>
<div class="line"><span class="lineno"> 1263</span>                        self.target_field_name,</div>
<div class="line"><span class="lineno"> 1264</span>                        self.source_field_name,</div>
<div class="line"><span class="lineno"> 1265</span>                        *objs,</div>
<div class="line"><span class="lineno"> 1266</span>                        through_defaults=through_defaults,</div>
<div class="line"><span class="lineno"> 1267</span>                    )</div>
<div class="line"><span class="lineno"> 1268</span> </div>
<div class="line"><span class="lineno"> 1269</span>        add.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1270</span> </div>
<div class="line"><span class="lineno"> 1271</span>        <span class="keyword">async def </span>aadd(self, *objs, through_defaults=None):</div>
<div class="line"><span class="lineno"> 1272</span>            <span class="keywordflow">return</span> await sync_to_async(self.add)(</div>
<div class="line"><span class="lineno"> 1273</span>                *objs, through_defaults=through_defaults</div>
<div class="line"><span class="lineno"> 1274</span>            )</div>
<div class="line"><span class="lineno"> 1275</span> </div>
<div class="line"><span class="lineno"> 1276</span>        aadd.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1277</span> </div>
<div class="line"><span class="lineno"> 1278</span>        <span class="keyword">def </span>remove(self, *objs):</div>
<div class="line"><span class="lineno"> 1279</span>            self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno"> 1280</span>            self._remove_items(self.source_field_name, self.target_field_name, *objs)</div>
<div class="line"><span class="lineno"> 1281</span> </div>
<div class="line"><span class="lineno"> 1282</span>        remove.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1283</span> </div>
<div class="line"><span class="lineno"> 1284</span>        <span class="keyword">async def </span>aremove(self, *objs):</div>
<div class="line"><span class="lineno"> 1285</span>            <span class="keywordflow">return</span> await sync_to_async(self.remove)(*objs)</div>
<div class="line"><span class="lineno"> 1286</span> </div>
<div class="line"><span class="lineno"> 1287</span>        aremove.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1288</span> </div>
<div class="line"><span class="lineno"> 1289</span>        <span class="keyword">def </span>clear(self):</div>
<div class="line"><span class="lineno"> 1290</span>            db = router.db_for_write(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1291</span>            <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno"> 1292</span>                signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1293</span>                    sender=self.through,</div>
<div class="line"><span class="lineno"> 1294</span>                    action=<span class="stringliteral">&quot;pre_clear&quot;</span>,</div>
<div class="line"><span class="lineno"> 1295</span>                    instance=self.instance,</div>
<div class="line"><span class="lineno"> 1296</span>                    reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1297</span>                    model=self.model,</div>
<div class="line"><span class="lineno"> 1298</span>                    pk_set=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno"> 1299</span>                    using=db,</div>
<div class="line"><span class="lineno"> 1300</span>                )</div>
<div class="line"><span class="lineno"> 1301</span>                self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno"> 1302</span>                filters = self._build_remove_filters(super().get_queryset().using(db))</div>
<div class="line"><span class="lineno"> 1303</span>                self.through._default_manager.using(db).filter(filters).delete()</div>
<div class="line"><span class="lineno"> 1304</span> </div>
<div class="line"><span class="lineno"> 1305</span>                signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1306</span>                    sender=self.through,</div>
<div class="line"><span class="lineno"> 1307</span>                    action=<span class="stringliteral">&quot;post_clear&quot;</span>,</div>
<div class="line"><span class="lineno"> 1308</span>                    instance=self.instance,</div>
<div class="line"><span class="lineno"> 1309</span>                    reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1310</span>                    model=self.model,</div>
<div class="line"><span class="lineno"> 1311</span>                    pk_set=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno"> 1312</span>                    using=db,</div>
<div class="line"><span class="lineno"> 1313</span>                )</div>
<div class="line"><span class="lineno"> 1314</span> </div>
<div class="line"><span class="lineno"> 1315</span>        clear.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1316</span> </div>
<div class="line"><span class="lineno"> 1317</span>        <span class="keyword">async def </span>aclear(self):</div>
<div class="line"><span class="lineno"> 1318</span>            <span class="keywordflow">return</span> await sync_to_async(self.clear)()</div>
<div class="line"><span class="lineno"> 1319</span> </div>
<div class="line"><span class="lineno"> 1320</span>        aclear.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1321</span> </div>
<div class="line"><span class="lineno"> 1322</span>        <span class="keyword">def </span>set(self, objs, *, clear=False, through_defaults=None):</div>
<div class="line"><span class="lineno"> 1323</span>            <span class="comment"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span></div>
<div class="line"><span class="lineno"> 1324</span>            <span class="comment"># could be affected by `manager.clear()`. Refs #19816.</span></div>
<div class="line"><span class="lineno"> 1325</span>            objs = tuple(objs)</div>
<div class="line"><span class="lineno"> 1326</span> </div>
<div class="line"><span class="lineno"> 1327</span>            db = router.db_for_write(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1328</span>            <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno"> 1329</span>                <span class="keywordflow">if</span> clear:</div>
<div class="line"><span class="lineno"> 1330</span>                    self.clear()</div>
<div class="line"><span class="lineno"> 1331</span>                    self.add(*objs, through_defaults=through_defaults)</div>
<div class="line"><span class="lineno"> 1332</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1333</span>                    old_ids = set(</div>
<div class="line"><span class="lineno"> 1334</span>                        self.using(db).values_list(</div>
<div class="line"><span class="lineno"> 1335</span>                            self.target_field.target_field.attname, flat=<span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1336</span>                        )</div>
<div class="line"><span class="lineno"> 1337</span>                    )</div>
<div class="line"><span class="lineno"> 1338</span> </div>
<div class="line"><span class="lineno"> 1339</span>                    new_objs = []</div>
<div class="line"><span class="lineno"> 1340</span>                    <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno"> 1341</span>                        fk_val = (</div>
<div class="line"><span class="lineno"> 1342</span>                            self.target_field.get_foreign_related_value(obj)[0]</div>
<div class="line"><span class="lineno"> 1343</span>                            <span class="keywordflow">if</span> isinstance(obj, self.model)</div>
<div class="line"><span class="lineno"> 1344</span>                            <span class="keywordflow">else</span> self.target_field.get_prep_value(obj)</div>
<div class="line"><span class="lineno"> 1345</span>                        )</div>
<div class="line"><span class="lineno"> 1346</span>                        <span class="keywordflow">if</span> fk_val <span class="keywordflow">in</span> old_ids:</div>
<div class="line"><span class="lineno"> 1347</span>                            old_ids.remove(fk_val)</div>
<div class="line"><span class="lineno"> 1348</span>                        <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1349</span>                            new_objs.append(obj)</div>
<div class="line"><span class="lineno"> 1350</span> </div>
<div class="line"><span class="lineno"> 1351</span>                    self.remove(*old_ids)</div>
<div class="line"><span class="lineno"> 1352</span>                    self.add(*new_objs, through_defaults=through_defaults)</div>
<div class="line"><span class="lineno"> 1353</span> </div>
<div class="line"><span class="lineno"> 1354</span>        set.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1355</span> </div>
<div class="line"><span class="lineno"> 1356</span>        <span class="keyword">async def </span>aset(self, objs, *, clear=False, through_defaults=None):</div>
<div class="line"><span class="lineno"> 1357</span>            <span class="keywordflow">return</span> await sync_to_async(self.set)(</div>
<div class="line"><span class="lineno"> 1358</span>                objs=objs, clear=clear, through_defaults=through_defaults</div>
<div class="line"><span class="lineno"> 1359</span>            )</div>
<div class="line"><span class="lineno"> 1360</span> </div>
<div class="line"><span class="lineno"> 1361</span>        aset.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1362</span> </div>
<div class="line"><span class="lineno"> 1363</span>        <span class="keyword">def </span>create(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1364</span>            db = router.db_for_write(self.instance.__class__, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1365</span>            new_obj = super(ManyRelatedManager, self.db_manager(db)).create(**kwargs)</div>
<div class="line"><span class="lineno"> 1366</span>            self.add(new_obj, through_defaults=through_defaults)</div>
<div class="line"><span class="lineno"> 1367</span>            <span class="keywordflow">return</span> new_obj</div>
<div class="line"><span class="lineno"> 1368</span> </div>
<div class="line"><span class="lineno"> 1369</span>        create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1370</span> </div>
<div class="line"><span class="lineno"> 1371</span>        <span class="keyword">async def </span>acreate(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1372</span>            <span class="keywordflow">return</span> await sync_to_async(self.create)(</div>
<div class="line"><span class="lineno"> 1373</span>                through_defaults=through_defaults, **kwargs</div>
<div class="line"><span class="lineno"> 1374</span>            )</div>
<div class="line"><span class="lineno"> 1375</span> </div>
<div class="line"><span class="lineno"> 1376</span>        acreate.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1377</span> </div>
<div class="line"><span class="lineno"> 1378</span>        <span class="keyword">def </span>get_or_create(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1379</span>            db = router.db_for_write(self.instance.__class__, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1380</span>            obj, created = super(ManyRelatedManager, self.db_manager(db)).get_or_create(</div>
<div class="line"><span class="lineno"> 1381</span>                **kwargs</div>
<div class="line"><span class="lineno"> 1382</span>            )</div>
<div class="line"><span class="lineno"> 1383</span>            <span class="comment"># We only need to add() if created because if we got an object back</span></div>
<div class="line"><span class="lineno"> 1384</span>            <span class="comment"># from get() then the relationship already exists.</span></div>
<div class="line"><span class="lineno"> 1385</span>            <span class="keywordflow">if</span> created:</div>
<div class="line"><span class="lineno"> 1386</span>                self.add(obj, through_defaults=through_defaults)</div>
<div class="line"><span class="lineno"> 1387</span>            <span class="keywordflow">return</span> obj, created</div>
<div class="line"><span class="lineno"> 1388</span> </div>
<div class="line"><span class="lineno"> 1389</span>        get_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1390</span> </div>
<div class="line"><span class="lineno"> 1391</span>        <span class="keyword">async def </span>aget_or_create(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1392</span>            <span class="keywordflow">return</span> await sync_to_async(self.get_or_create)(</div>
<div class="line"><span class="lineno"> 1393</span>                through_defaults=through_defaults, **kwargs</div>
<div class="line"><span class="lineno"> 1394</span>            )</div>
<div class="line"><span class="lineno"> 1395</span> </div>
<div class="line"><span class="lineno"> 1396</span>        aget_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1397</span> </div>
<div class="line"><span class="lineno"> 1398</span>        <span class="keyword">def </span>update_or_create(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1399</span>            db = router.db_for_write(self.instance.__class__, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1400</span>            obj, created = super(</div>
<div class="line"><span class="lineno"> 1401</span>                ManyRelatedManager, self.db_manager(db)</div>
<div class="line"><span class="lineno"> 1402</span>            ).update_or_create(**kwargs)</div>
<div class="line"><span class="lineno"> 1403</span>            <span class="comment"># We only need to add() if created because if we got an object back</span></div>
<div class="line"><span class="lineno"> 1404</span>            <span class="comment"># from get() then the relationship already exists.</span></div>
<div class="line"><span class="lineno"> 1405</span>            <span class="keywordflow">if</span> created:</div>
<div class="line"><span class="lineno"> 1406</span>                self.add(obj, through_defaults=through_defaults)</div>
<div class="line"><span class="lineno"> 1407</span>            <span class="keywordflow">return</span> obj, created</div>
<div class="line"><span class="lineno"> 1408</span> </div>
<div class="line"><span class="lineno"> 1409</span>        update_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1410</span> </div>
<div class="line"><span class="lineno"> 1411</span>        <span class="keyword">async def </span>aupdate_or_create(self, *, through_defaults=None, **kwargs):</div>
<div class="line"><span class="lineno"> 1412</span>            <span class="keywordflow">return</span> await sync_to_async(self.update_or_create)(</div>
<div class="line"><span class="lineno"> 1413</span>                through_defaults=through_defaults, **kwargs</div>
<div class="line"><span class="lineno"> 1414</span>            )</div>
<div class="line"><span class="lineno"> 1415</span> </div>
<div class="line"><span class="lineno"> 1416</span>        aupdate_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno"> 1417</span> </div>
<div class="line"><span class="lineno"> 1418</span>        <span class="keyword">def </span>_get_target_ids(self, target_field_name, objs):</div>
<div class="line"><span class="lineno"> 1419</span>            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1420</span><span class="stringliteral">            Return the set of ids of `objs` that the target field references.</span></div>
<div class="line"><span class="lineno"> 1421</span><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1422</span>            <span class="keyword">from</span> <a class="code hl_namespace" href="namespacedjango_1_1db_1_1models.html">django.db.models</a> <span class="keyword">import</span> Model</div>
<div class="line"><span class="lineno"> 1423</span> </div>
<div class="line"><span class="lineno"> 1424</span>            target_ids = set()</div>
<div class="line"><span class="lineno"> 1425</span>            target_field = self.through._meta.get_field(target_field_name)</div>
<div class="line"><span class="lineno"> 1426</span>            <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno"> 1427</span>                <span class="keywordflow">if</span> isinstance(obj, self.model):</div>
<div class="line"><span class="lineno"> 1428</span>                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> router.allow_relation(obj, self.instance):</div>
<div class="line"><span class="lineno"> 1429</span>                        <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno"> 1430</span>                            <span class="stringliteral">&#39;Cannot add &quot;%r&quot;: instance is on database &quot;%s&quot;, &#39;</span></div>
<div class="line"><span class="lineno"> 1431</span>                            <span class="stringliteral">&#39;value is on database &quot;%s&quot;&#39;</span></div>
<div class="line"><span class="lineno"> 1432</span>                            % (obj, self.instance._state.db, obj._state.db)</div>
<div class="line"><span class="lineno"> 1433</span>                        )</div>
<div class="line"><span class="lineno"> 1434</span>                    target_id = target_field.get_foreign_related_value(obj)[0]</div>
<div class="line"><span class="lineno"> 1435</span>                    <span class="keywordflow">if</span> target_id <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno"> 1436</span>                        <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno"> 1437</span>                            <span class="stringliteral">&#39;Cannot add &quot;%r&quot;: the value for field &quot;%s&quot; is None&#39;</span></div>
<div class="line"><span class="lineno"> 1438</span>                            % (obj, target_field_name)</div>
<div class="line"><span class="lineno"> 1439</span>                        )</div>
<div class="line"><span class="lineno"> 1440</span>                    target_ids.add(target_id)</div>
<div class="line"><span class="lineno"> 1441</span>                <span class="keywordflow">elif</span> isinstance(obj, Model):</div>
<div class="line"><span class="lineno"> 1442</span>                    <span class="keywordflow">raise</span> TypeError(</div>
<div class="line"><span class="lineno"> 1443</span>                        <span class="stringliteral">&quot;&#39;%s&#39; instance expected, got %r&quot;</span></div>
<div class="line"><span class="lineno"> 1444</span>                        % (self.model._meta.object_name, obj)</div>
<div class="line"><span class="lineno"> 1445</span>                    )</div>
<div class="line"><span class="lineno"> 1446</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1447</span>                    target_ids.add(target_field.get_prep_value(obj))</div>
<div class="line"><span class="lineno"> 1448</span>            <span class="keywordflow">return</span> target_ids</div>
<div class="line"><span class="lineno"> 1449</span> </div>
<div class="line"><span class="lineno"> 1450</span>        <span class="keyword">def </span>_get_missing_target_ids(</div>
<div class="line"><span class="lineno"> 1451</span>            self, source_field_name, target_field_name, db, target_ids</div>
<div class="line"><span class="lineno"> 1452</span>        ):</div>
<div class="line"><span class="lineno"> 1453</span>            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1454</span><span class="stringliteral">            Return the subset of ids of `objs` that aren&#39;t already assigned to</span></div>
<div class="line"><span class="lineno"> 1455</span><span class="stringliteral">            this relationship.</span></div>
<div class="line"><span class="lineno"> 1456</span><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1457</span>            vals = (</div>
<div class="line"><span class="lineno"> 1458</span>                self.through._default_manager.using(db)</div>
<div class="line"><span class="lineno"> 1459</span>                .values_list(target_field_name, flat=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno"> 1460</span>                .filter(</div>
<div class="line"><span class="lineno"> 1461</span>                    **{</div>
<div class="line"><span class="lineno"> 1462</span>                        source_field_name: self.related_val[0],</div>
<div class="line"><span class="lineno"> 1463</span>                        <span class="stringliteral">&quot;%s__in&quot;</span> % target_field_name: target_ids,</div>
<div class="line"><span class="lineno"> 1464</span>                    }</div>
<div class="line"><span class="lineno"> 1465</span>                )</div>
<div class="line"><span class="lineno"> 1466</span>            )</div>
<div class="line"><span class="lineno"> 1467</span>            <span class="keywordflow">return</span> target_ids.difference(vals)</div>
<div class="line"><span class="lineno"> 1468</span> </div>
<div class="line"><span class="lineno"> 1469</span>        <span class="keyword">def </span>_get_add_plan(self, db, source_field_name):</div>
<div class="line"><span class="lineno"> 1470</span>            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1471</span><span class="stringliteral">            Return a boolean triple of the way the add should be performed.</span></div>
<div class="line"><span class="lineno"> 1472</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno"> 1473</span><span class="stringliteral">            The first element is whether or not bulk_create(ignore_conflicts)</span></div>
<div class="line"><span class="lineno"> 1474</span><span class="stringliteral">            can be used, the second whether or not signals must be sent, and</span></div>
<div class="line"><span class="lineno"> 1475</span><span class="stringliteral">            the third element is whether or not the immediate bulk insertion</span></div>
<div class="line"><span class="lineno"> 1476</span><span class="stringliteral">            with conflicts ignored can be performed.</span></div>
<div class="line"><span class="lineno"> 1477</span><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno"> 1478</span>            <span class="comment"># Conflicts can be ignored when the intermediary model is</span></div>
<div class="line"><span class="lineno"> 1479</span>            <span class="comment"># auto-created as the only possible collision is on the</span></div>
<div class="line"><span class="lineno"> 1480</span>            <span class="comment"># (source_id, target_id) tuple. The same assertion doesn&#39;t hold for</span></div>
<div class="line"><span class="lineno"> 1481</span>            <span class="comment"># user-defined intermediary models as they could have other fields</span></div>
<div class="line"><span class="lineno"> 1482</span>            <span class="comment"># causing conflicts which must be surfaced.</span></div>
<div class="line"><span class="lineno"> 1483</span>            can_ignore_conflicts = (</div>
<div class="line"><span class="lineno"> 1484</span>                self.through._meta.auto_created <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keyword">False</span></div>
<div class="line"><span class="lineno"> 1485</span>                <span class="keywordflow">and</span> connections[db].features.supports_ignore_conflicts</div>
<div class="line"><span class="lineno"> 1486</span>            )</div>
<div class="line"><span class="lineno"> 1487</span>            <span class="comment"># Don&#39;t send the signal when inserting duplicate data row</span></div>
<div class="line"><span class="lineno"> 1488</span>            <span class="comment"># for symmetrical reverse entries.</span></div>
<div class="line"><span class="lineno"> 1489</span>            must_send_signals = (</div>
<div class="line"><span class="lineno"> 1490</span>                self.reverse <span class="keywordflow">or</span> source_field_name == self.source_field_name</div>
<div class="line"><span class="lineno"> 1491</span>            ) <span class="keywordflow">and</span> (signals.m2m_changed.has_listeners(self.through))</div>
<div class="line"><span class="lineno"> 1492</span>            <span class="comment"># Fast addition through bulk insertion can only be performed</span></div>
<div class="line"><span class="lineno"> 1493</span>            <span class="comment"># if no m2m_changed listeners are connected for self.through</span></div>
<div class="line"><span class="lineno"> 1494</span>            <span class="comment"># as they require the added set of ids to be provided via</span></div>
<div class="line"><span class="lineno"> 1495</span>            <span class="comment"># pk_set.</span></div>
<div class="line"><span class="lineno"> 1496</span>            <span class="keywordflow">return</span> (</div>
<div class="line"><span class="lineno"> 1497</span>                can_ignore_conflicts,</div>
<div class="line"><span class="lineno"> 1498</span>                must_send_signals,</div>
<div class="line"><span class="lineno"> 1499</span>                (can_ignore_conflicts <span class="keywordflow">and</span> <span class="keywordflow">not</span> must_send_signals),</div>
<div class="line"><span class="lineno"> 1500</span>            )</div>
<div class="line"><span class="lineno"> 1501</span> </div>
<div class="line"><span class="lineno"> 1502</span>        <span class="keyword">def </span>_add_items(</div>
<div class="line"><span class="lineno"> 1503</span>            self, source_field_name, target_field_name, *objs, through_defaults=None</div>
<div class="line"><span class="lineno"> 1504</span>        ):</div>
<div class="line"><span class="lineno"> 1505</span>            <span class="comment"># source_field_name: the PK fieldname in join table for the source object</span></div>
<div class="line"><span class="lineno"> 1506</span>            <span class="comment"># target_field_name: the PK fieldname in join table for the target object</span></div>
<div class="line"><span class="lineno"> 1507</span>            <span class="comment"># *objs - objects to add. Either object instances, or primary keys</span></div>
<div class="line"><span class="lineno"> 1508</span>            <span class="comment"># of object instances.</span></div>
<div class="line"><span class="lineno"> 1509</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> objs:</div>
<div class="line"><span class="lineno"> 1510</span>                <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno"> 1511</span> </div>
<div class="line"><span class="lineno"> 1512</span>            through_defaults = dict(resolve_callables(through_defaults <span class="keywordflow">or</span> {}))</div>
<div class="line"><span class="lineno"> 1513</span>            target_ids = self._get_target_ids(target_field_name, objs)</div>
<div class="line"><span class="lineno"> 1514</span>            db = router.db_for_write(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1515</span>            can_ignore_conflicts, must_send_signals, can_fast_add = self._get_add_plan(</div>
<div class="line"><span class="lineno"> 1516</span>                db, source_field_name</div>
<div class="line"><span class="lineno"> 1517</span>            )</div>
<div class="line"><span class="lineno"> 1518</span>            <span class="keywordflow">if</span> can_fast_add:</div>
<div class="line"><span class="lineno"> 1519</span>                self.through._default_manager.using(db).bulk_create(</div>
<div class="line"><span class="lineno"> 1520</span>                    [</div>
<div class="line"><span class="lineno"> 1521</span>                        self.through(</div>
<div class="line"><span class="lineno"> 1522</span>                            **{</div>
<div class="line"><span class="lineno"> 1523</span>                                <span class="stringliteral">&quot;%s_id&quot;</span> % source_field_name: self.related_val[0],</div>
<div class="line"><span class="lineno"> 1524</span>                                <span class="stringliteral">&quot;%s_id&quot;</span> % target_field_name: target_id,</div>
<div class="line"><span class="lineno"> 1525</span>                            }</div>
<div class="line"><span class="lineno"> 1526</span>                        )</div>
<div class="line"><span class="lineno"> 1527</span>                        <span class="keywordflow">for</span> target_id <span class="keywordflow">in</span> target_ids</div>
<div class="line"><span class="lineno"> 1528</span>                    ],</div>
<div class="line"><span class="lineno"> 1529</span>                    ignore_conflicts=<span class="keyword">True</span>,</div>
<div class="line"><span class="lineno"> 1530</span>                )</div>
<div class="line"><span class="lineno"> 1531</span>                <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno"> 1532</span> </div>
<div class="line"><span class="lineno"> 1533</span>            missing_target_ids = self._get_missing_target_ids(</div>
<div class="line"><span class="lineno"> 1534</span>                source_field_name, target_field_name, db, target_ids</div>
<div class="line"><span class="lineno"> 1535</span>            )</div>
<div class="line"><span class="lineno"> 1536</span>            <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno"> 1537</span>                <span class="keywordflow">if</span> must_send_signals:</div>
<div class="line"><span class="lineno"> 1538</span>                    signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1539</span>                        sender=self.through,</div>
<div class="line"><span class="lineno"> 1540</span>                        action=<span class="stringliteral">&quot;pre_add&quot;</span>,</div>
<div class="line"><span class="lineno"> 1541</span>                        instance=self.instance,</div>
<div class="line"><span class="lineno"> 1542</span>                        reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1543</span>                        model=self.model,</div>
<div class="line"><span class="lineno"> 1544</span>                        pk_set=missing_target_ids,</div>
<div class="line"><span class="lineno"> 1545</span>                        using=db,</div>
<div class="line"><span class="lineno"> 1546</span>                    )</div>
<div class="line"><span class="lineno"> 1547</span>                <span class="comment"># Add the ones that aren&#39;t there already.</span></div>
<div class="line"><span class="lineno"> 1548</span>                self.through._default_manager.using(db).bulk_create(</div>
<div class="line"><span class="lineno"> 1549</span>                    [</div>
<div class="line"><span class="lineno"> 1550</span>                        self.through(</div>
<div class="line"><span class="lineno"> 1551</span>                            **through_defaults,</div>
<div class="line"><span class="lineno"> 1552</span>                            **{</div>
<div class="line"><span class="lineno"> 1553</span>                                <span class="stringliteral">&quot;%s_id&quot;</span> % source_field_name: self.related_val[0],</div>
<div class="line"><span class="lineno"> 1554</span>                                <span class="stringliteral">&quot;%s_id&quot;</span> % target_field_name: target_id,</div>
<div class="line"><span class="lineno"> 1555</span>                            },</div>
<div class="line"><span class="lineno"> 1556</span>                        )</div>
<div class="line"><span class="lineno"> 1557</span>                        <span class="keywordflow">for</span> target_id <span class="keywordflow">in</span> missing_target_ids</div>
<div class="line"><span class="lineno"> 1558</span>                    ],</div>
<div class="line"><span class="lineno"> 1559</span>                    ignore_conflicts=can_ignore_conflicts,</div>
<div class="line"><span class="lineno"> 1560</span>                )</div>
<div class="line"><span class="lineno"> 1561</span> </div>
<div class="line"><span class="lineno"> 1562</span>                <span class="keywordflow">if</span> must_send_signals:</div>
<div class="line"><span class="lineno"> 1563</span>                    signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1564</span>                        sender=self.through,</div>
<div class="line"><span class="lineno"> 1565</span>                        action=<span class="stringliteral">&quot;post_add&quot;</span>,</div>
<div class="line"><span class="lineno"> 1566</span>                        instance=self.instance,</div>
<div class="line"><span class="lineno"> 1567</span>                        reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1568</span>                        model=self.model,</div>
<div class="line"><span class="lineno"> 1569</span>                        pk_set=missing_target_ids,</div>
<div class="line"><span class="lineno"> 1570</span>                        using=db,</div>
<div class="line"><span class="lineno"> 1571</span>                    )</div>
<div class="line"><span class="lineno"> 1572</span> </div>
<div class="line"><span class="lineno"> 1573</span>        <span class="keyword">def </span>_remove_items(self, source_field_name, target_field_name, *objs):</div>
<div class="line"><span class="lineno"> 1574</span>            <span class="comment"># source_field_name: the PK colname in join table for the source object</span></div>
<div class="line"><span class="lineno"> 1575</span>            <span class="comment"># target_field_name: the PK colname in join table for the target object</span></div>
<div class="line"><span class="lineno"> 1576</span>            <span class="comment"># *objs - objects to remove. Either object instances, or primary</span></div>
<div class="line"><span class="lineno"> 1577</span>            <span class="comment"># keys of object instances.</span></div>
<div class="line"><span class="lineno"> 1578</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> objs:</div>
<div class="line"><span class="lineno"> 1579</span>                <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno"> 1580</span> </div>
<div class="line"><span class="lineno"> 1581</span>            <span class="comment"># Check that all the objects are of the right type</span></div>
<div class="line"><span class="lineno"> 1582</span>            old_ids = set()</div>
<div class="line"><span class="lineno"> 1583</span>            <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno"> 1584</span>                <span class="keywordflow">if</span> isinstance(obj, self.model):</div>
<div class="line"><span class="lineno"> 1585</span>                    fk_val = self.target_field.get_foreign_related_value(obj)[0]</div>
<div class="line"><span class="lineno"> 1586</span>                    old_ids.add(fk_val)</div>
<div class="line"><span class="lineno"> 1587</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1588</span>                    old_ids.add(obj)</div>
<div class="line"><span class="lineno"> 1589</span> </div>
<div class="line"><span class="lineno"> 1590</span>            db = router.db_for_write(self.through, instance=self.instance)</div>
<div class="line"><span class="lineno"> 1591</span>            <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno"> 1592</span>                <span class="comment"># Send a signal to the other end if need be.</span></div>
<div class="line"><span class="lineno"> 1593</span>                signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1594</span>                    sender=self.through,</div>
<div class="line"><span class="lineno"> 1595</span>                    action=<span class="stringliteral">&quot;pre_remove&quot;</span>,</div>
<div class="line"><span class="lineno"> 1596</span>                    instance=self.instance,</div>
<div class="line"><span class="lineno"> 1597</span>                    reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1598</span>                    model=self.model,</div>
<div class="line"><span class="lineno"> 1599</span>                    pk_set=old_ids,</div>
<div class="line"><span class="lineno"> 1600</span>                    using=db,</div>
<div class="line"><span class="lineno"> 1601</span>                )</div>
<div class="line"><span class="lineno"> 1602</span>                target_model_qs = super().get_queryset()</div>
<div class="line"><span class="lineno"> 1603</span>                <span class="keywordflow">if</span> target_model_qs._has_filters():</div>
<div class="line"><span class="lineno"> 1604</span>                    old_vals = target_model_qs.using(db).filter(</div>
<div class="line"><span class="lineno"> 1605</span>                        **{<span class="stringliteral">&quot;%s__in&quot;</span> % self.target_field.target_field.attname: old_ids}</div>
<div class="line"><span class="lineno"> 1606</span>                    )</div>
<div class="line"><span class="lineno"> 1607</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno"> 1608</span>                    old_vals = old_ids</div>
<div class="line"><span class="lineno"> 1609</span>                filters = self._build_remove_filters(old_vals)</div>
<div class="line"><span class="lineno"> 1610</span>                self.through._default_manager.using(db).filter(filters).delete()</div>
<div class="line"><span class="lineno"> 1611</span> </div>
<div class="line"><span class="lineno"> 1612</span>                signals.m2m_changed.send(</div>
<div class="line"><span class="lineno"> 1613</span>                    sender=self.through,</div>
<div class="line"><span class="lineno"> 1614</span>                    action=<span class="stringliteral">&quot;post_remove&quot;</span>,</div>
<div class="line"><span class="lineno"> 1615</span>                    instance=self.instance,</div>
<div class="line"><span class="lineno"> 1616</span>                    reverse=self.reverse,</div>
<div class="line"><span class="lineno"> 1617</span>                    model=self.model,</div>
<div class="line"><span class="lineno"> 1618</span>                    pk_set=old_ids,</div>
<div class="line"><span class="lineno"> 1619</span>                    using=db,</div>
<div class="line"><span class="lineno"> 1620</span>                )</div>
<div class="line"><span class="lineno"> 1621</span> </div>
<div class="line"><span class="lineno"> 1622</span>    <span class="keywordflow">return</span> ManyRelatedManager</div>
<div class="ttc" id="anamespacedjango_1_1db_1_1models_html"><div class="ttname"><a href="namespacedjango_1_1db_1_1models.html">django.db.models</a></div><div class="ttdef"><b>Definition</b> <a href="_e_n_v_2_lib_2site-packages_2django_2db_2models_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="related__descriptors_8py_source.html#l01015">django.db.models.fields.related_descriptors.ManyToManyDescriptor.related_manager_cls()</a>.</p>

</div>
</div>
<a id="a6c10dab2e0e460b34fd6d3207e609c7c" name="a6c10dab2e0e460b34fd6d3207e609c7c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6c10dab2e0e460b34fd6d3207e609c7c">&#9670;&#160;</a></span>create_reverse_many_to_one_manager()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.create_reverse_many_to_one_manager </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>superclass</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>rel</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Create a manager for the reverse side of a many-to-one relation.

This manager subclasses another manager, generally the default manager of
the related model, and adds behaviors specific to many-to-one relations.
</pre> 
<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00671">671</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  671</span><span class="keyword">def </span>create_reverse_many_to_one_manager(superclass, rel):</div>
<div class="line"><span class="lineno">  672</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  673</span><span class="stringliteral">    Create a manager for the reverse side of a many-to-one relation.</span></div>
<div class="line"><span class="lineno">  674</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  675</span><span class="stringliteral">    This manager subclasses another manager, generally the default manager of</span></div>
<div class="line"><span class="lineno">  676</span><span class="stringliteral">    the related model, and adds behaviors specific to many-to-one relations.</span></div>
<div class="line"><span class="lineno">  677</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  678</span> </div>
<div class="line"><span class="lineno">  679</span>    <span class="keyword">class </span>RelatedManager(superclass, AltersData):</div>
<div class="line"><span class="lineno">  680</span>        <span class="keyword">def </span>__init__(self, instance):</div>
<div class="line"><span class="lineno">  681</span>            super().__init__()</div>
<div class="line"><span class="lineno">  682</span> </div>
<div class="line"><span class="lineno">  683</span>            self.instance = instance</div>
<div class="line"><span class="lineno">  684</span>            self.model = rel.related_model</div>
<div class="line"><span class="lineno">  685</span>            self.field = rel.field</div>
<div class="line"><span class="lineno">  686</span> </div>
<div class="line"><span class="lineno">  687</span>            self.core_filters = {self.field.name: instance}</div>
<div class="line"><span class="lineno">  688</span> </div>
<div class="line"><span class="lineno">  689</span>        <span class="keyword">def </span>__call__(self, *, manager):</div>
<div class="line"><span class="lineno">  690</span>            manager = getattr(self.model, manager)</div>
<div class="line"><span class="lineno">  691</span>            manager_class = create_reverse_many_to_one_manager(manager.__class__, rel)</div>
<div class="line"><span class="lineno">  692</span>            <span class="keywordflow">return</span> manager_class(self.instance)</div>
<div class="line"><span class="lineno">  693</span> </div>
<div class="line"><span class="lineno">  694</span>        do_not_call_in_templates = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  695</span> </div>
<div class="line"><span class="lineno">  696</span>        <span class="keyword">def </span>_check_fk_val(self):</div>
<div class="line"><span class="lineno">  697</span>            <span class="keywordflow">for</span> field <span class="keywordflow">in</span> self.field.foreign_related_fields:</div>
<div class="line"><span class="lineno">  698</span>                <span class="keywordflow">if</span> getattr(self.instance, field.attname) <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  699</span>                    <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno">  700</span>                        f<span class="stringliteral">&#39;&quot;{self.instance!r}&quot; needs to have a value for field &#39;</span></div>
<div class="line"><span class="lineno">  701</span>                        f<span class="stringliteral">&#39;&quot;{field.attname}&quot; before this relationship can be used.&#39;</span></div>
<div class="line"><span class="lineno">  702</span>                    )</div>
<div class="line"><span class="lineno">  703</span> </div>
<div class="line"><span class="lineno">  704</span>        <span class="keyword">def </span>_apply_rel_filters(self, queryset):</div>
<div class="line"><span class="lineno">  705</span>            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  706</span><span class="stringliteral">            Filter the queryset for the instance this manager is bound to.</span></div>
<div class="line"><span class="lineno">  707</span><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  708</span>            db = self._db <span class="keywordflow">or</span> router.db_for_read(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  709</span>            empty_strings_as_null = connections[</div>
<div class="line"><span class="lineno">  710</span>                db</div>
<div class="line"><span class="lineno">  711</span>            ].features.interprets_empty_strings_as_nulls</div>
<div class="line"><span class="lineno">  712</span>            queryset._add_hints(instance=self.instance)</div>
<div class="line"><span class="lineno">  713</span>            <span class="keywordflow">if</span> self._db:</div>
<div class="line"><span class="lineno">  714</span>                queryset = queryset.using(self._db)</div>
<div class="line"><span class="lineno">  715</span>            queryset._defer_next_filter = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  716</span>            queryset = queryset.filter(**self.core_filters)</div>
<div class="line"><span class="lineno">  717</span>            <span class="keywordflow">for</span> field <span class="keywordflow">in</span> self.field.foreign_related_fields:</div>
<div class="line"><span class="lineno">  718</span>                val = getattr(self.instance, field.attname)</div>
<div class="line"><span class="lineno">  719</span>                <span class="keywordflow">if</span> val <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> (val == <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">and</span> empty_strings_as_null):</div>
<div class="line"><span class="lineno">  720</span>                    <span class="keywordflow">return</span> queryset.none()</div>
<div class="line"><span class="lineno">  721</span>            <span class="keywordflow">if</span> self.field.many_to_one:</div>
<div class="line"><span class="lineno">  722</span>                <span class="comment"># Guard against field-like objects such as GenericRelation</span></div>
<div class="line"><span class="lineno">  723</span>                <span class="comment"># that abuse create_reverse_many_to_one_manager() with reverse</span></div>
<div class="line"><span class="lineno">  724</span>                <span class="comment"># one-to-many relationships instead and break known related</span></div>
<div class="line"><span class="lineno">  725</span>                <span class="comment"># objects assignment.</span></div>
<div class="line"><span class="lineno">  726</span>                <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  727</span>                    target_field = self.field.target_field</div>
<div class="line"><span class="lineno">  728</span>                <span class="keywordflow">except</span> FieldError:</div>
<div class="line"><span class="lineno">  729</span>                    <span class="comment"># The relationship has multiple target fields. Use a tuple</span></div>
<div class="line"><span class="lineno">  730</span>                    <span class="comment"># for related object id.</span></div>
<div class="line"><span class="lineno">  731</span>                    rel_obj_id = tuple(</div>
<div class="line"><span class="lineno">  732</span>                        [</div>
<div class="line"><span class="lineno">  733</span>                            getattr(self.instance, target_field.attname)</div>
<div class="line"><span class="lineno">  734</span>                            <span class="keywordflow">for</span> target_field <span class="keywordflow">in</span> self.field.path_infos[-1].target_fields</div>
<div class="line"><span class="lineno">  735</span>                        ]</div>
<div class="line"><span class="lineno">  736</span>                    )</div>
<div class="line"><span class="lineno">  737</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  738</span>                    rel_obj_id = getattr(self.instance, target_field.attname)</div>
<div class="line"><span class="lineno">  739</span>                queryset._known_related_objects = {</div>
<div class="line"><span class="lineno">  740</span>                    self.field: {rel_obj_id: self.instance}</div>
<div class="line"><span class="lineno">  741</span>                }</div>
<div class="line"><span class="lineno">  742</span>            <span class="keywordflow">return</span> queryset</div>
<div class="line"><span class="lineno">  743</span> </div>
<div class="line"><span class="lineno">  744</span>        <span class="keyword">def </span>_remove_prefetched_objects(self):</div>
<div class="line"><span class="lineno">  745</span>            <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  746</span>                self.instance._prefetched_objects_cache.pop(</div>
<div class="line"><span class="lineno">  747</span>                    self.field.remote_field.cache_name</div>
<div class="line"><span class="lineno">  748</span>                )</div>
<div class="line"><span class="lineno">  749</span>            <span class="keywordflow">except</span> (AttributeError, KeyError):</div>
<div class="line"><span class="lineno">  750</span>                <span class="keywordflow">pass</span>  <span class="comment"># nothing to clear from cache</span></div>
<div class="line"><span class="lineno">  751</span> </div>
<div class="line"><span class="lineno">  752</span>        <span class="keyword">def </span>get_queryset(self):</div>
<div class="line"><span class="lineno">  753</span>            <span class="comment"># Even if this relation is not to pk, we require still pk value.</span></div>
<div class="line"><span class="lineno">  754</span>            <span class="comment"># The wish is that the instance has been already saved to DB,</span></div>
<div class="line"><span class="lineno">  755</span>            <span class="comment"># although having a pk value isn&#39;t a guarantee of that.</span></div>
<div class="line"><span class="lineno">  756</span>            <span class="keywordflow">if</span> self.instance.pk <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  757</span>                <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno">  758</span>                    f<span class="stringliteral">&quot;{self.instance.__class__.__name__!r} instance needs to have a &quot;</span></div>
<div class="line"><span class="lineno">  759</span>                    f<span class="stringliteral">&quot;primary key value before this relationship can be used.&quot;</span></div>
<div class="line"><span class="lineno">  760</span>                )</div>
<div class="line"><span class="lineno">  761</span>            <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  762</span>                <span class="keywordflow">return</span> self.instance._prefetched_objects_cache[</div>
<div class="line"><span class="lineno">  763</span>                    self.field.remote_field.cache_name</div>
<div class="line"><span class="lineno">  764</span>                ]</div>
<div class="line"><span class="lineno">  765</span>            <span class="keywordflow">except</span> (AttributeError, KeyError):</div>
<div class="line"><span class="lineno">  766</span>                queryset = super().get_queryset()</div>
<div class="line"><span class="lineno">  767</span>                <span class="keywordflow">return</span> self._apply_rel_filters(queryset)</div>
<div class="line"><span class="lineno">  768</span> </div>
<div class="line"><span class="lineno">  769</span>        <span class="keyword">def </span>get_prefetch_queryset(self, instances, queryset=None):</div>
<div class="line"><span class="lineno">  770</span>            warnings.warn(</div>
<div class="line"><span class="lineno">  771</span>                <span class="stringliteral">&quot;get_prefetch_queryset() is deprecated. Use get_prefetch_querysets() &quot;</span></div>
<div class="line"><span class="lineno">  772</span>                <span class="stringliteral">&quot;instead.&quot;</span>,</div>
<div class="line"><span class="lineno">  773</span>                RemovedInDjango60Warning,</div>
<div class="line"><span class="lineno">  774</span>                stacklevel=2,</div>
<div class="line"><span class="lineno">  775</span>            )</div>
<div class="line"><span class="lineno">  776</span>            <span class="keywordflow">if</span> queryset <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  777</span>                <span class="keywordflow">return</span> self.get_prefetch_querysets(instances)</div>
<div class="line"><span class="lineno">  778</span>            <span class="keywordflow">return</span> self.get_prefetch_querysets(instances, [queryset])</div>
<div class="line"><span class="lineno">  779</span> </div>
<div class="line"><span class="lineno">  780</span>        <span class="keyword">def </span>get_prefetch_querysets(self, instances, querysets=None):</div>
<div class="line"><span class="lineno">  781</span>            <span class="keywordflow">if</span> querysets <span class="keywordflow">and</span> len(querysets) != 1:</div>
<div class="line"><span class="lineno">  782</span>                <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno">  783</span>                    <span class="stringliteral">&quot;querysets argument of get_prefetch_querysets() should have a &quot;</span></div>
<div class="line"><span class="lineno">  784</span>                    <span class="stringliteral">&quot;length of 1.&quot;</span></div>
<div class="line"><span class="lineno">  785</span>                )</div>
<div class="line"><span class="lineno">  786</span>            queryset = querysets[0] <span class="keywordflow">if</span> querysets <span class="keywordflow">else</span> super().get_queryset()</div>
<div class="line"><span class="lineno">  787</span>            queryset._add_hints(instance=instances[0])</div>
<div class="line"><span class="lineno">  788</span>            queryset = queryset.using(queryset._db <span class="keywordflow">or</span> self._db)</div>
<div class="line"><span class="lineno">  789</span> </div>
<div class="line"><span class="lineno">  790</span>            rel_obj_attr = self.field.get_local_related_value</div>
<div class="line"><span class="lineno">  791</span>            instance_attr = self.field.get_foreign_related_value</div>
<div class="line"><span class="lineno">  792</span>            instances_dict = {instance_attr(inst): inst <span class="keywordflow">for</span> inst <span class="keywordflow">in</span> instances}</div>
<div class="line"><span class="lineno">  793</span>            queryset = _filter_prefetch_queryset(queryset, self.field.name, instances)</div>
<div class="line"><span class="lineno">  794</span> </div>
<div class="line"><span class="lineno">  795</span>            <span class="comment"># Since we just bypassed this class&#39; get_queryset(), we must manage</span></div>
<div class="line"><span class="lineno">  796</span>            <span class="comment"># the reverse relation manually.</span></div>
<div class="line"><span class="lineno">  797</span>            <span class="keywordflow">for</span> rel_obj <span class="keywordflow">in</span> queryset:</div>
<div class="line"><span class="lineno">  798</span>                <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.field.is_cached(rel_obj):</div>
<div class="line"><span class="lineno">  799</span>                    instance = instances_dict[rel_obj_attr(rel_obj)]</div>
<div class="line"><span class="lineno">  800</span>                    setattr(rel_obj, self.field.name, instance)</div>
<div class="line"><span class="lineno">  801</span>            cache_name = self.field.remote_field.cache_name</div>
<div class="line"><span class="lineno">  802</span>            <span class="keywordflow">return</span> queryset, rel_obj_attr, instance_attr, <span class="keyword">False</span>, cache_name, <span class="keyword">False</span></div>
<div class="line"><span class="lineno">  803</span> </div>
<div class="line"><span class="lineno">  804</span>        <span class="keyword">def </span>add(self, *objs, bulk=True):</div>
<div class="line"><span class="lineno">  805</span>            self._check_fk_val()</div>
<div class="line"><span class="lineno">  806</span>            self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno">  807</span>            db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  808</span> </div>
<div class="line"><span class="lineno">  809</span>            <span class="keyword">def </span>check_and_update_obj(obj):</div>
<div class="line"><span class="lineno">  810</span>                <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(obj, self.model):</div>
<div class="line"><span class="lineno">  811</span>                    <span class="keywordflow">raise</span> TypeError(</div>
<div class="line"><span class="lineno">  812</span>                        <span class="stringliteral">&quot;&#39;%s&#39; instance expected, got %r&quot;</span></div>
<div class="line"><span class="lineno">  813</span>                        % (</div>
<div class="line"><span class="lineno">  814</span>                            self.model._meta.object_name,</div>
<div class="line"><span class="lineno">  815</span>                            obj,</div>
<div class="line"><span class="lineno">  816</span>                        )</div>
<div class="line"><span class="lineno">  817</span>                    )</div>
<div class="line"><span class="lineno">  818</span>                setattr(obj, self.field.name, self.instance)</div>
<div class="line"><span class="lineno">  819</span> </div>
<div class="line"><span class="lineno">  820</span>            <span class="keywordflow">if</span> bulk:</div>
<div class="line"><span class="lineno">  821</span>                pks = []</div>
<div class="line"><span class="lineno">  822</span>                <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno">  823</span>                    check_and_update_obj(obj)</div>
<div class="line"><span class="lineno">  824</span>                    <span class="keywordflow">if</span> obj._state.adding <span class="keywordflow">or</span> obj._state.db != db:</div>
<div class="line"><span class="lineno">  825</span>                        <span class="keywordflow">raise</span> ValueError(</div>
<div class="line"><span class="lineno">  826</span>                            <span class="stringliteral">&quot;%r instance isn&#39;t saved. Use bulk=False or save &quot;</span></div>
<div class="line"><span class="lineno">  827</span>                            <span class="stringliteral">&quot;the object first.&quot;</span> % obj</div>
<div class="line"><span class="lineno">  828</span>                        )</div>
<div class="line"><span class="lineno">  829</span>                    pks.append(obj.pk)</div>
<div class="line"><span class="lineno">  830</span>                self.model._base_manager.using(db).filter(pk__in=pks).update(</div>
<div class="line"><span class="lineno">  831</span>                    **{</div>
<div class="line"><span class="lineno">  832</span>                        self.field.name: self.instance,</div>
<div class="line"><span class="lineno">  833</span>                    }</div>
<div class="line"><span class="lineno">  834</span>                )</div>
<div class="line"><span class="lineno">  835</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  836</span>                <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno">  837</span>                    <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno">  838</span>                        check_and_update_obj(obj)</div>
<div class="line"><span class="lineno">  839</span>                        obj.save()</div>
<div class="line"><span class="lineno">  840</span> </div>
<div class="line"><span class="lineno">  841</span>        add.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  842</span> </div>
<div class="line"><span class="lineno">  843</span>        <span class="keyword">async def </span>aadd(self, *objs, bulk=True):</div>
<div class="line"><span class="lineno">  844</span>            <span class="keywordflow">return</span> await sync_to_async(self.add)(*objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  845</span> </div>
<div class="line"><span class="lineno">  846</span>        aadd.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  847</span> </div>
<div class="line"><span class="lineno">  848</span>        <span class="keyword">def </span>create(self, **kwargs):</div>
<div class="line"><span class="lineno">  849</span>            self._check_fk_val()</div>
<div class="line"><span class="lineno">  850</span>            self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno">  851</span>            kwargs[self.field.name] = self.instance</div>
<div class="line"><span class="lineno">  852</span>            db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  853</span>            <span class="keywordflow">return</span> super(RelatedManager, self.db_manager(db)).create(**kwargs)</div>
<div class="line"><span class="lineno">  854</span> </div>
<div class="line"><span class="lineno">  855</span>        create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  856</span> </div>
<div class="line"><span class="lineno">  857</span>        <span class="keyword">async def </span>acreate(self, **kwargs):</div>
<div class="line"><span class="lineno">  858</span>            <span class="keywordflow">return</span> await sync_to_async(self.create)(**kwargs)</div>
<div class="line"><span class="lineno">  859</span> </div>
<div class="line"><span class="lineno">  860</span>        acreate.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  861</span> </div>
<div class="line"><span class="lineno">  862</span>        <span class="keyword">def </span>get_or_create(self, **kwargs):</div>
<div class="line"><span class="lineno">  863</span>            self._check_fk_val()</div>
<div class="line"><span class="lineno">  864</span>            kwargs[self.field.name] = self.instance</div>
<div class="line"><span class="lineno">  865</span>            db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  866</span>            <span class="keywordflow">return</span> super(RelatedManager, self.db_manager(db)).get_or_create(**kwargs)</div>
<div class="line"><span class="lineno">  867</span> </div>
<div class="line"><span class="lineno">  868</span>        get_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  869</span> </div>
<div class="line"><span class="lineno">  870</span>        <span class="keyword">async def </span>aget_or_create(self, **kwargs):</div>
<div class="line"><span class="lineno">  871</span>            <span class="keywordflow">return</span> await sync_to_async(self.get_or_create)(**kwargs)</div>
<div class="line"><span class="lineno">  872</span> </div>
<div class="line"><span class="lineno">  873</span>        aget_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  874</span> </div>
<div class="line"><span class="lineno">  875</span>        <span class="keyword">def </span>update_or_create(self, **kwargs):</div>
<div class="line"><span class="lineno">  876</span>            self._check_fk_val()</div>
<div class="line"><span class="lineno">  877</span>            kwargs[self.field.name] = self.instance</div>
<div class="line"><span class="lineno">  878</span>            db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  879</span>            <span class="keywordflow">return</span> super(RelatedManager, self.db_manager(db)).update_or_create(**kwargs)</div>
<div class="line"><span class="lineno">  880</span> </div>
<div class="line"><span class="lineno">  881</span>        update_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  882</span> </div>
<div class="line"><span class="lineno">  883</span>        <span class="keyword">async def </span>aupdate_or_create(self, **kwargs):</div>
<div class="line"><span class="lineno">  884</span>            <span class="keywordflow">return</span> await sync_to_async(self.update_or_create)(**kwargs)</div>
<div class="line"><span class="lineno">  885</span> </div>
<div class="line"><span class="lineno">  886</span>        aupdate_or_create.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  887</span> </div>
<div class="line"><span class="lineno">  888</span>        <span class="comment"># remove() and clear() are only provided if the ForeignKey can have a</span></div>
<div class="line"><span class="lineno">  889</span>        <span class="comment"># value of null.</span></div>
<div class="line"><span class="lineno">  890</span>        <span class="keywordflow">if</span> rel.field.null:</div>
<div class="line"><span class="lineno">  891</span> </div>
<div class="line"><span class="lineno">  892</span>            <span class="keyword">def </span>remove(self, *objs, bulk=True):</div>
<div class="line"><span class="lineno">  893</span>                <span class="keywordflow">if</span> <span class="keywordflow">not</span> objs:</div>
<div class="line"><span class="lineno">  894</span>                    <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno">  895</span>                self._check_fk_val()</div>
<div class="line"><span class="lineno">  896</span>                val = self.field.get_foreign_related_value(self.instance)</div>
<div class="line"><span class="lineno">  897</span>                old_ids = set()</div>
<div class="line"><span class="lineno">  898</span>                <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno">  899</span>                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(obj, self.model):</div>
<div class="line"><span class="lineno">  900</span>                        <span class="keywordflow">raise</span> TypeError(</div>
<div class="line"><span class="lineno">  901</span>                            <span class="stringliteral">&quot;&#39;%s&#39; instance expected, got %r&quot;</span></div>
<div class="line"><span class="lineno">  902</span>                            % (</div>
<div class="line"><span class="lineno">  903</span>                                self.model._meta.object_name,</div>
<div class="line"><span class="lineno">  904</span>                                obj,</div>
<div class="line"><span class="lineno">  905</span>                            )</div>
<div class="line"><span class="lineno">  906</span>                        )</div>
<div class="line"><span class="lineno">  907</span>                    <span class="comment"># Is obj actually part of this descriptor set?</span></div>
<div class="line"><span class="lineno">  908</span>                    <span class="keywordflow">if</span> self.field.get_local_related_value(obj) == val:</div>
<div class="line"><span class="lineno">  909</span>                        old_ids.add(obj.pk)</div>
<div class="line"><span class="lineno">  910</span>                    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  911</span>                        <span class="keywordflow">raise</span> self.field.remote_field.model.DoesNotExist(</div>
<div class="line"><span class="lineno">  912</span>                            <span class="stringliteral">&quot;%r is not related to %r.&quot;</span> % (obj, self.instance)</div>
<div class="line"><span class="lineno">  913</span>                        )</div>
<div class="line"><span class="lineno">  914</span>                self._clear(self.filter(pk__in=old_ids), bulk)</div>
<div class="line"><span class="lineno">  915</span> </div>
<div class="line"><span class="lineno">  916</span>            remove.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  917</span> </div>
<div class="line"><span class="lineno">  918</span>            <span class="keyword">async def </span>aremove(self, *objs, bulk=True):</div>
<div class="line"><span class="lineno">  919</span>                <span class="keywordflow">return</span> await sync_to_async(self.remove)(*objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  920</span> </div>
<div class="line"><span class="lineno">  921</span>            aremove.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  922</span> </div>
<div class="line"><span class="lineno">  923</span>            <span class="keyword">def </span>clear(self, *, bulk=True):</div>
<div class="line"><span class="lineno">  924</span>                self._check_fk_val()</div>
<div class="line"><span class="lineno">  925</span>                self._clear(self, bulk)</div>
<div class="line"><span class="lineno">  926</span> </div>
<div class="line"><span class="lineno">  927</span>            clear.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  928</span> </div>
<div class="line"><span class="lineno">  929</span>            <span class="keyword">async def </span>aclear(self, *, bulk=True):</div>
<div class="line"><span class="lineno">  930</span>                <span class="keywordflow">return</span> await sync_to_async(self.clear)(bulk=bulk)</div>
<div class="line"><span class="lineno">  931</span> </div>
<div class="line"><span class="lineno">  932</span>            aclear.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  933</span> </div>
<div class="line"><span class="lineno">  934</span>            <span class="keyword">def </span>_clear(self, queryset, bulk):</div>
<div class="line"><span class="lineno">  935</span>                self._remove_prefetched_objects()</div>
<div class="line"><span class="lineno">  936</span>                db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  937</span>                queryset = queryset.using(db)</div>
<div class="line"><span class="lineno">  938</span>                <span class="keywordflow">if</span> bulk:</div>
<div class="line"><span class="lineno">  939</span>                    <span class="comment"># `QuerySet.update()` is intrinsically atomic.</span></div>
<div class="line"><span class="lineno">  940</span>                    queryset.update(**{self.field.name: <span class="keywordtype">None</span>})</div>
<div class="line"><span class="lineno">  941</span>                <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  942</span>                    <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno">  943</span>                        <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> queryset:</div>
<div class="line"><span class="lineno">  944</span>                            setattr(obj, self.field.name, <span class="keywordtype">None</span>)</div>
<div class="line"><span class="lineno">  945</span>                            obj.save(update_fields=[self.field.name])</div>
<div class="line"><span class="lineno">  946</span> </div>
<div class="line"><span class="lineno">  947</span>            _clear.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  948</span> </div>
<div class="line"><span class="lineno">  949</span>        <span class="keyword">def </span>set(self, objs, *, bulk=True, clear=False):</div>
<div class="line"><span class="lineno">  950</span>            self._check_fk_val()</div>
<div class="line"><span class="lineno">  951</span>            <span class="comment"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span></div>
<div class="line"><span class="lineno">  952</span>            <span class="comment"># could be affected by `manager.clear()`. Refs #19816.</span></div>
<div class="line"><span class="lineno">  953</span>            objs = tuple(objs)</div>
<div class="line"><span class="lineno">  954</span> </div>
<div class="line"><span class="lineno">  955</span>            <span class="keywordflow">if</span> self.field.null:</div>
<div class="line"><span class="lineno">  956</span>                db = router.db_for_write(self.model, instance=self.instance)</div>
<div class="line"><span class="lineno">  957</span>                <span class="keyword">with</span> transaction.atomic(using=db, savepoint=<span class="keyword">False</span>):</div>
<div class="line"><span class="lineno">  958</span>                    <span class="keywordflow">if</span> clear:</div>
<div class="line"><span class="lineno">  959</span>                        self.clear(bulk=bulk)</div>
<div class="line"><span class="lineno">  960</span>                        self.add(*objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  961</span>                    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  962</span>                        old_objs = set(self.using(db).all())</div>
<div class="line"><span class="lineno">  963</span>                        new_objs = []</div>
<div class="line"><span class="lineno">  964</span>                        <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:</div>
<div class="line"><span class="lineno">  965</span>                            <span class="keywordflow">if</span> obj <span class="keywordflow">in</span> old_objs:</div>
<div class="line"><span class="lineno">  966</span>                                old_objs.remove(obj)</div>
<div class="line"><span class="lineno">  967</span>                            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  968</span>                                new_objs.append(obj)</div>
<div class="line"><span class="lineno">  969</span> </div>
<div class="line"><span class="lineno">  970</span>                        self.remove(*old_objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  971</span>                        self.add(*new_objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  972</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  973</span>                self.add(*objs, bulk=bulk)</div>
<div class="line"><span class="lineno">  974</span> </div>
<div class="line"><span class="lineno">  975</span>        set.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  976</span> </div>
<div class="line"><span class="lineno">  977</span>        <span class="keyword">async def </span>aset(self, objs, *, bulk=True, clear=False):</div>
<div class="line"><span class="lineno">  978</span>            <span class="keywordflow">return</span> await sync_to_async(self.set)(objs=objs, bulk=bulk, clear=clear)</div>
<div class="line"><span class="lineno">  979</span> </div>
<div class="line"><span class="lineno">  980</span>        aset.alters_data = <span class="keyword">True</span></div>
<div class="line"><span class="lineno">  981</span> </div>
<div class="line"><span class="lineno">  982</span>    <span class="keywordflow">return</span> RelatedManager</div>
<div class="line"><span class="lineno">  983</span> </div>
<div class="line"><span class="lineno">  984</span> </div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="related__descriptors_8py_source.html#l00635">django.db.models.fields.related_descriptors.ReverseManyToOneDescriptor.related_manager_cls()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a467ceebd29540846b8fe8c3a673f3394" name="a467ceebd29540846b8fe8c3a673f3394"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a467ceebd29540846b8fe8c3a673f3394">&#9670;&#160;</a></span>_db</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors._db = self.instance)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel protected">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00713">713</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="ae2c6e5dc63d0890d13975747dbeac400" name="ae2c6e5dc63d0890d13975747dbeac400"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2c6e5dc63d0890d13975747dbeac400">&#9670;&#160;</a></span>add</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.add = True):</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00844">844</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="ab30b373b473f7e0af7c445611fce9411" name="ab30b373b473f7e0af7c445611fce9411"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab30b373b473f7e0af7c445611fce9411">&#9670;&#160;</a></span>clear</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.clear = True):</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00930">930</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a673ae17f91c49dce56a7b9e1f0f41470" name="a673ae17f91c49dce56a7b9e1f0f41470"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a673ae17f91c49dce56a7b9e1f0f41470">&#9670;&#160;</a></span>core_filters</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.core_filters = {self.field.name: <a class="el" href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">instance</a>}</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00687">687</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a26699fb0e36f5d12dd0a7f4860b083e3" name="a26699fb0e36f5d12dd0a7f4860b083e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26699fb0e36f5d12dd0a7f4860b083e3">&#9670;&#160;</a></span>create</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.create = True</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00858">858</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a5bcaffa31dadce5a2e6ef1a504bd09c3" name="a5bcaffa31dadce5a2e6ef1a504bd09c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5bcaffa31dadce5a2e6ef1a504bd09c3">&#9670;&#160;</a></span>field</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.field = rel.field</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00685">685</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="aee77a3024dd052b98723409b59e7d8eb" name="aee77a3024dd052b98723409b59e7d8eb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aee77a3024dd052b98723409b59e7d8eb">&#9670;&#160;</a></span>get_or_create</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.get_or_create = True</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00871">871</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a2d4f6982d2433fa20c5b1a44f4cd95c9" name="a2d4f6982d2433fa20c5b1a44f4cd95c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">&#9670;&#160;</a></span>instance</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.instance = instance</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00683">683</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="af42babb78272caa993abe3f2e8c5b7af" name="af42babb78272caa993abe3f2e8c5b7af"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af42babb78272caa993abe3f2e8c5b7af">&#9670;&#160;</a></span>model</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.model = rel.related_model</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00684">684</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="aec979db6b6d598a5cb6c1ac6931b097a" name="aec979db6b6d598a5cb6c1ac6931b097a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aec979db6b6d598a5cb6c1ac6931b097a">&#9670;&#160;</a></span>pk_field_names</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">dict django.db.models.fields.related_descriptors.pk_field_names = {}</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01068">1068</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="aefcc4f73d38a9ff1abbbf8b685d428d6" name="aefcc4f73d38a9ff1abbbf8b685d428d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aefcc4f73d38a9ff1abbbf8b685d428d6">&#9670;&#160;</a></span>prefetch_cache_name</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.prefetch_cache_name = rel.field.name</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01049">1049</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="ac734e56d5215d9fd6734fd090837e407" name="ac734e56d5215d9fd6734fd090837e407"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac734e56d5215d9fd6734fd090837e407">&#9670;&#160;</a></span>query_field_name</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.query_field_name = rel.field.related_query_name()</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01048">1048</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a302babfeed8a95db9673dc64eefe79a6" name="a302babfeed8a95db9673dc64eefe79a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a302babfeed8a95db9673dc64eefe79a6">&#9670;&#160;</a></span>related_val</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.related_val = self.source_field.get_foreign_related_value(<a class="el" href="#a2d4f6982d2433fa20c5b1a44f4cd95c9">instance</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01074">1074</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="af9fc51a0d300117b8545f65d72602189" name="af9fc51a0d300117b8545f65d72602189"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af9fc51a0d300117b8545f65d72602189">&#9670;&#160;</a></span>remove</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.remove = True):</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00919">919</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="afe5e5775a26d78c3a643e18d11a544ab" name="afe5e5775a26d78c3a643e18d11a544ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe5e5775a26d78c3a643e18d11a544ab">&#9670;&#160;</a></span>reverse</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.reverse = reverse</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01062">1062</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a76709af4ab7f9f51879819876156f958" name="a76709af4ab7f9f51879819876156f958"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a76709af4ab7f9f51879819876156f958">&#9670;&#160;</a></span>set</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.set = False):</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00978">978</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="aa79e9a3830b25d12956c03af331b0ac7" name="aa79e9a3830b25d12956c03af331b0ac7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa79e9a3830b25d12956c03af331b0ac7">&#9670;&#160;</a></span>source_field</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.source_field = self.through._meta.get_field(self.source_field_name)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01064">1064</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="ad7db328efb2d4bc74d5f8fac3864e9ba" name="ad7db328efb2d4bc74d5f8fac3864e9ba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad7db328efb2d4bc74d5f8fac3864e9ba">&#9670;&#160;</a></span>source_field_name</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.source_field_name = rel.field.m2m_field_name()</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01050">1050</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="aa77338e7519a3fefad05d3a1ce5fe1fc" name="aa77338e7519a3fefad05d3a1ce5fe1fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa77338e7519a3fefad05d3a1ce5fe1fc">&#9670;&#160;</a></span>symmetrical</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool django.db.models.fields.related_descriptors.symmetrical = rel.symmetrical</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01052">1052</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a467795b8a5e9c1011924cd2735457bbc" name="a467795b8a5e9c1011924cd2735457bbc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a467795b8a5e9c1011924cd2735457bbc">&#9670;&#160;</a></span>target_field</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.target_field = self.through._meta.get_field(self.target_field_name)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01065">1065</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a67bd88f37d0cdc6e4bbbba682984518d" name="a67bd88f37d0cdc6e4bbbba682984518d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67bd88f37d0cdc6e4bbbba682984518d">&#9670;&#160;</a></span>target_field_name</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.target_field_name = rel.field.m2m_reverse_field_name()</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01051">1051</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="a6dd62a8f1fc42a6bebd6732535aa92b7" name="a6dd62a8f1fc42a6bebd6732535aa92b7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6dd62a8f1fc42a6bebd6732535aa92b7">&#9670;&#160;</a></span>through</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.through = rel.through</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l01061">1061</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
<a id="ab96d91c80eef1aca61b7697c37ee61db" name="ab96d91c80eef1aca61b7697c37ee61db"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab96d91c80eef1aca61b7697c37ee61db">&#9670;&#160;</a></span>update_or_create</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">django.db.models.fields.related_descriptors.update_or_create = True</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="related__descriptors_8py_source.html#l00884">884</a> of file <a class="el" href="related__descriptors_8py_source.html">related_descriptors.py</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacedjango.html">django</a></li><li class="navelem"><a class="el" href="namespacedjango_1_1db.html">db</a></li><li class="navelem"><a class="el" href="namespacedjango_1_1db_1_1models.html">models</a></li><li class="navelem"><a class="el" href="namespacedjango_1_1db_1_1models_1_1fields.html">fields</a></li><li class="navelem"><a class="el" href="namespacedjango_1_1db_1_1models_1_1fields_1_1related__descriptors.html">related_descriptors</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
